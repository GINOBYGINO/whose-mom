<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èª°çš„ç›¸ç°¿? v0.5</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #00b894;
            --secondary-color: #00cec9;
            --bg-grad: linear-gradient(135deg, #2d3436 0%, #000000 100%);
            --card-bg: rgba(255, 255, 255, 0.1);
            --text-color: #dfe6e9;
            --accent-yellow: #fdcb6e;
            --danger-red: #ff7675;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Segoe UI', "Microsoft JhengHei", sans-serif;
            background: var(--bg-grad);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container { width: 100%; max-width: 480px; padding: 15px; text-align: center; }

        .card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.15);
            margin-top: 15px;
            position: relative;
        }

        h1 { 
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2.2rem; margin: 10px 0; font-weight: 800;
        }

        .hidden { display: none !important; }

        /* è¼¸å…¥èˆ‡ä¸‹æ‹‰é¸å–® */
        input[type="text"], select {
            width: 100%; padding: 12px; background: rgba(0,0,0,0.4);
            border: 2px solid #555; border-radius: 12px; color: white;
            font-size: 1rem; outline: none; margin-bottom: 10px;
        }
        
        .setting-row {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 8px; font-size: 0.9rem; color: #ccc;
        }
        .setting-row select { width: 60%; margin-bottom: 0; padding: 5px; }

        button.main-btn {
            width: 100%; background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: #fff; border: none; padding: 15px; font-size: 1.1rem;
            border-radius: 12px; cursor: pointer; font-weight: bold; margin-top: 5px;
        }

        /* (1) ç›´åˆ—æ¸…å–®å¼åå–® */
        .player-list-container {
            text-align: left; background: rgba(0,0,0,0.2);
            border-radius: 12px; padding: 10px; margin: 15px 0;
        }
        .player-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .player-row:last-child { border-bottom: none; }
        .kick-btn {
            background: var(--danger-red); color: white; border: none;
            padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; cursor: pointer;
        }

        .room-display { font-size: 1.8rem; color: var(--accent-yellow); font-family: monospace; margin: 10px 0; }
        .timer { font-size: 3rem; font-weight: 800; color: var(--danger-red); margin: 5px 0; }
        .scroll-box { max-height: 45vh; overflow-y: auto; border-radius: 15px; background: rgba(0,0,0,0.2); padding: 10px; }
        .photo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .photo-card { aspect-ratio: 1/1; border-radius: 12px; overflow: hidden; border: 4px solid transparent; }
        .photo-card.selected { border-color: var(--accent-yellow); }
        .photo-card img { width: 100%; height: 100%; object-fit: cover; }

        .version-tag { position: fixed; bottom: 8px; right: 12px; color: #555; font-size: 0.75rem; }
    </style>
</head>
<body>

<div class="container">
    <h1>èª°çš„ç›¸ç°¿?</h1>

    <div id="view-lobby" class="view">
        <div class="card">
            <h3>éŠæˆ²è¨­å®š</h3>
            <input type="text" id="player-name" placeholder="è¼¸å…¥æš±ç¨±" maxlength="10">
            
            <div id="host-settings-ui">
                <div class="setting-row">
                    <span>éŠæˆ²è¼ªæ•¸</span>
                    <select id="set-rounds">
                        <option value="1">1 è¼ª (æ¯äººç•¶ä¸€æ¬¡é ˜è¢–)</option>
                        <option value="2" selected>2 è¼ª (æ¨è–¦)</option>
                        <option value="3">3 è¼ª (è¼ƒé•·)</option>
                    </select>
                </div>
                <div class="setting-row">
                    <span>é ˜è¢–æ€è€ƒæ™‚é–“</span>
                    <select id="set-topic-time">
                        <option value="15">15 ç§’ (æ¥µé€Ÿ)</option>
                        <option value="20" selected>20 ç§’ (æ¨™æº–)</option>
                        <option value="40">40 ç§’ (æ‚ é–’)</option>
                    </select>
                </div>
                <div class="setting-row">
                    <span>åœ–ç‰‡é¸æ“‡æ™‚é–“</span>
                    <select id="set-upload-time">
                        <option value="30">30 ç§’ (å¿«ç¯€å¥)</option>
                        <option value="50" selected>50 ç§’ (æ¨™æº–)</option>
                        <option value="90">90 ç§’ (æ¼«é•·)</option>
                    </select>
                </div>
            </div>

            <button class="main-btn" id="btn-create" onclick="createRoom()">å»ºç«‹æˆ¿é–“ (Host)</button>
            <div style="margin: 15px 0; opacity: 0.5;">- æˆ– -</div>
            <input type="text" id="room-id-input" placeholder="è¼¸å…¥æˆ¿è™Ÿ ID">
            <button class="main-btn" id="btn-join" onclick="joinRoom()">åŠ å…¥æˆ¿é–“</button>
        </div>
    </div>

    <div id="view-waiting" class="view hidden">
        <div class="card">
            <div class="room-display">
                <span id="display-room-id">...</span>
                <i class="fas fa-copy" style="font-size:1rem; cursor:pointer; color:#777" onclick="copyId()"></i>
            </div>
            
            <div class="player-list-container" id="player-list"></div>
            
            <div id="settings-preview" style="font-size: 0.8rem; color: #888; margin-bottom: 10px;"></div>

            <button id="start-game-btn" class="main-btn hidden" onclick="hostStartGame()">é–‹å§‹éŠæˆ²</button>
            <p id="waiting-msg" class="hidden">ç­‰å¾…æˆ¿ä¸»é–‹å§‹éŠæˆ²...</p>
        </div>
    </div>

    <div id="view-game" class="view hidden">
        <div class="card">
            <div id="phase-action" class="phase">
                <p id="leader-msg" style="color:var(--accent-yellow)"></p>
                <h2 id="topic-display" style="color:var(--secondary-color)">ç­‰å¾…å‡ºé¡Œ...</h2>
                <div class="timer" id="game-timer">--</div>
                
                <div id="leader-input-area" class="hidden">
                    <input type="text" id="topic-input" placeholder="è¼¸å…¥é¡Œç›®...">
                    <button class="main-btn" onclick="submitTopic()">ç™¼å¸ƒé¡Œç›®</button>
                </div>

                <div id="player-upload-area" class="hidden">
                    <label for="photo-input" style="display:block; padding:20px; border:2px dashed #666; border-radius:12px; cursor:pointer;">
                        <i class="fas fa-image" style="font-size:2rem; color:#aaa;"></i>
                        <p>é¸æ“‡ç…§ç‰‡</p>
                    </label>
                    <input type="file" id="photo-input" accept="image/*" style="display:none" onchange="previewImg(this)">
                    <div id="p-area" style="display:none; margin:10px 0;">
                        <img id="p-img" style="width:100px; height:100px; object-fit:cover; border-radius:10px;">
                    </div>
                    <button class="main-btn" id="btn-upload" onclick="uploadImg()">ç¢ºèªä¸Šå‚³</button>
                </div>
                <div id="wait-others-msg" class="hidden"><p>ç­‰å¾…å…¶ä»–äºº...</p></div>
            </div>

            <div id="phase-voting" class="phase hidden">
                <h3 id="vote-prompt" style="color:var(--accent-yellow)"></h3>
                <div class="timer" id="vote-timer">--</div>
                <div class="scroll-box">
                    <div class="photo-grid" id="voting-grid"></div>
                </div>
                <button class="main-btn" id="btn-submit-vote" onclick="confirmVote()" disabled>ç¢ºèªæŠ•ç¥¨</button>
            </div>

            <div id="phase-results" class="phase hidden">
                <h3>å›åˆçµæœ</h3>
                <div id="round-scores" style="text-align:left;"></div>
            </div>
        </div>
    </div>

    <div id="view-final" class="view hidden">
        <div class="card">
            <h2 style="color:var(--accent-yellow)">ğŸ† éŠæˆ²çµæŸ ğŸ†</h2>
            <div id="final-list" style="text-align:left; margin-bottom:20px;"></div>
            <button class="main-btn" onclick="location.reload()">å›é¦–é </button>
        </div>
    </div>
</div>

<div class="version-tag">v0.5 | æˆ¿ä¸»ç®¡ç†èˆ‡è‡ªå®šç¾©æ™‚é–“</div>

<script>
    let peer, conn, roomId;
    let myName = "";
    let isHost = false;
    let players = [];
    let currentLeaderId = "";
    let selectedTargetId = null;
    let timerInt;

    // (4) éŠæˆ²è¦å‰‡è®Šæ•¸
    let gameSettings = {
        rounds: 2,
        topicTime: 20,
        uploadTime: 50
    };

    function createRoom() {
        myName = document.getElementById('player-name').value.trim();
        if(!myName) return alert("è«‹è¼¸å…¥æš±ç¨±");
        
        // æŠ“å–è¨­å®š
        gameSettings.rounds = parseInt(document.getElementById('set-rounds').value);
        gameSettings.topicTime = parseInt(document.getElementById('set-topic-time').value);
        gameSettings.uploadTime = parseInt(document.getElementById('set-upload-time').value);

        peer = new Peer();
        peer.on('open', id => {
            isHost = true;
            roomId = id;
            players = [{ id: id, name: myName, score: 0, photo: null, votes: 0, voted: false }];
            setupLobby();
        });
        peer.on('connection', c => {
            c.on('open', () => {
                c.on('data', data => handleHostRecv(data, c));
                // æ–°ç©å®¶åŠ å…¥ï¼Œç«‹åˆ»åŒæ­¥è¨­å®š
                c.send({ type: 'SYNC_SETTINGS', settings: gameSettings });
            });
        });
    }

    function joinRoom() {
        myName = document.getElementById('player-name').value.trim();
        let targetId = document.getElementById('room-id-input').value.trim();
        if(!myName || !targetId) return alert("è«‹å¡«å¯«åå­—èˆ‡æˆ¿è™Ÿ");

        peer = new Peer();
        peer.on('open', id => {
            conn = peer.connect(targetId);
            conn.on('open', () => {
                conn.send({ type: 'JOIN', name: myName });
                roomId = targetId;
            });
            conn.on('data', data => handleClientRecv(data));
        });
    }

    // (2) è¸¢äººåŠŸèƒ½
    function kickPlayer(peerId) {
        if(!isHost) return;
        const target = players.find(p => p.id === peerId);
        if(target && target.conn) {
            target.conn.send({ type: 'KICKED' });
            setTimeout(() => target.conn.close(), 500);
        }
        players = players.filter(p => p.id !== peerId);
        broadcastLobby();
        setupLobby();
    }

    function handleHostRecv(data, c) {
        switch(data.type) {
            case 'JOIN':
                if(players.some(p => p.id === c.peer)) return;
                players.push({ id: c.peer, name: data.name, score: 0, photo: null, votes: 0, voted: false, conn: c });
                broadcastLobby();
                setupLobby();
                break;
            case 'SEND_TOPIC': startUpload(data.topic); break;
            case 'SEND_PHOTO':
                let p = players.find(x => x.id === c.peer);
                if(p) p.photo = data.photo;
                checkAllUploads();
                break;
            case 'SEND_VOTE': recordVote(c.peer, data.targetId); break;
        }
    }

    function handleClientRecv(data) {
        switch(data.type) {
            case 'KICKED': alert("ä½ å·²è¢«æˆ¿ä¸»ç§»å‡ºæˆ¿é–“"); location.reload(); break;
            case 'SYNC_SETTINGS': gameSettings = data.settings; break;
            case 'LOBBY_DATA': players = data.list; setupLobby(); break;
            case 'STATE_SYNC': renderState(data); break;
        }
    }

    function broadcastLobby() {
        broadcast({ type: 'LOBBY_DATA', list: players.map(p => ({id: p.id, name: p.name})) });
    }

    function broadcast(msg) {
        players.forEach(p => { if(p.conn && p.conn.open) p.conn.send(msg); });
    }

    // éŠæˆ²æ ¸å¿ƒé‚è¼¯
    function hostStartGame() {
        if(players.length < 3) return alert("è‡³å°‘éœ€è¦ 3 ä½ç©å®¶");
        nextRound(0);
    }

    function nextRound(roundIdx) {
        const totalLeadersCount = players.length;
        const maxRounds = totalLeadersCount * gameSettings.rounds;
        
        if(roundIdx >= maxRounds) {
            broadcastState('FINAL', { players: players.map(p => ({name:p.name, score:p.score})) });
            return;
        }
        players.forEach(p => { p.photo = null; p.votes = 0; p.voted = false; });
        const leader = players[roundIdx % totalLeadersCount];
        currentLeaderId = leader.id;
        broadcastState('WAIT_TOPIC', { leaderId: leader.id, leaderName: leader.name, round: roundIdx });
    }

    function startUpload(topic) {
        broadcastState('UPLOADING', { topic: topic, leaderId: currentLeaderId });
    }

    function checkAllUploads() {
        const uploaders = players.filter(p => p.id !== currentLeaderId);
        if(uploaders.every(p => p.photo)) {
            const pool = uploaders.map(p => ({id: p.id, img: p.photo})).sort(() => Math.random() - 0.5);
            broadcastState('VOTING', { photos: pool, leaderId: currentLeaderId });
        }
    }

    function recordVote(vId, tId) {
        let voter = players.find(p => p.id === vId);
        if(!voter || voter.voted) return;
        voter.voted = true;

        if(vId === currentLeaderId) {
            let target = players.find(p => p.id === tId);
            if(target) target.score += 2;
        } else {
            let target = players.find(p => p.id === tId);
            if(target) target.votes += 1;
        }

        if(players.every(p => p.voted)) {
            const others = players.filter(p => p.id !== currentLeaderId);
            const maxV = Math.max(...others.map(o => o.votes));
            if(maxV > 0) {
                others.forEach(o => { if(o.votes === maxV) o.score = Math.max(0, o.score - 1); });
            }
            broadcastState('RESULTS', { players: players.map(p => ({name:p.name, score:p.score})) });
            setTimeout(() => {
                let currentR = parseInt(document.body.dataset.round || 0);
                nextRound(currentR + 1);
            }, 5000);
        }
    }

    function broadcastState(phase, payload) {
        document.body.dataset.round = payload.round !== undefined ? payload.round : (document.body.dataset.round || 0);
        const state = { type: 'STATE_SYNC', phase: phase, ...payload };
        renderState(state);
        broadcast(state);
    }

    // UI æ§åˆ¶
    function renderState(data) {
        switchView('view-game');
        document.querySelectorAll('.phase').forEach(p => p.classList.add('hidden'));
        
        if(data.phase === 'WAIT_TOPIC') {
            showPhase('phase-action');
            document.getElementById('topic-display').innerText = "é ˜è¢–æ­£åœ¨æ€è€ƒé¡Œç›®...";
            document.getElementById('leader-input-area').classList.toggle('hidden', peer.id !== data.leaderId);
            document.getElementById('player-upload-area').classList.add('hidden');
            document.getElementById('leader-msg').innerText = peer.id === data.leaderId ? "ä½ æ˜¯é ˜è¢–" : "é ˜è¢–æ˜¯ " + data.leaderName;
            document.getElementById('wait-others-msg').classList.add('hidden');
            // (3) é ˜è¢–æ€è€ƒå€’æ•¸
            startTimer(gameSettings.topicTime, 'game-timer');
        }
        else if(data.phase === 'UPLOADING') {
            showPhase('phase-action');
            document.getElementById('topic-display').innerText = "é¡Œç›®ï¼š" + data.topic;
            document.getElementById('leader-input-area').classList.add('hidden');
            startTimer(gameSettings.uploadTime, 'game-timer');

            if(peer.id === data.leaderId) {
                document.getElementById('player-upload-area').classList.add('hidden');
                document.getElementById('wait-others-msg').classList.remove('hidden');
            } else {
                document.getElementById('player-upload-area').classList.remove('hidden');
                document.getElementById('wait-others-msg').classList.add('hidden');
                document.getElementById('p-area').style.display = 'none';
            }
        }
        else if(data.phase === 'VOTING') {
            showPhase('phase-voting');
            startTimer(20, 'vote-timer');
            document.getElementById('vote-prompt').innerText = (peer.id === data.leaderId) ? "æŠ•æœ€å–œæ­¡çš„ (+2åˆ†)" : "æŠ•æœ€è¨å­çš„ (-1åˆ†)";
            renderGrid(data.photos);
            document.getElementById('btn-submit-vote').disabled = true;
            document.getElementById('btn-submit-vote').classList.remove('hidden');
        }
        else if(data.phase === 'RESULTS') {
            showPhase('phase-results');
            const html = data.players.sort((a,b)=>b.score-a.score).map(p => `
                <div class="player-row"><span>${p.name}</span><b>${p.score} åˆ†</b></div>`).join('');
            document.getElementById('round-scores').innerHTML = html;
        }
        else if(data.phase === 'FINAL') {
            switchView('view-final');
            const html = data.players.sort((a,b)=>b.score-a.score).map((p,i) => `<div class="player-row"><span>#${i+1} ${p.name}</span><b>${p.score}åˆ†</b></div>`).join('');
            document.getElementById('final-list').innerHTML = html;
        }
    }

    function submitTopic() {
        const topic = document.getElementById('topic-input').value.trim();
        if(!topic) return;
        if(isHost) startUpload(topic);
        else conn.send({ type: 'SEND_TOPIC', topic: topic });
    }

    function uploadImg() {
        const file = document.getElementById('photo-input').files[0];
        if(!file) return alert("é¸å¼µç…§ç‰‡å§");
        const reader = new FileReader();
        reader.onload = e => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const scale = Math.min(500/img.width, 500/img.height);
                canvas.width = img.width * scale; canvas.height = img.height * scale;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                if(isHost) { players.find(p=>p.id===peer.id).photo = dataUrl; checkAllUploads(); }
                else conn.send({ type: 'SEND_PHOTO', photo: dataUrl });
                document.getElementById('player-upload-area').classList.add('hidden');
                document.getElementById('wait-others-msg').classList.remove('hidden');
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function renderGrid(photos) {
        const grid = document.getElementById('voting-grid');
        grid.innerHTML = "";
        photos.forEach(p => {
            const div = document.createElement('div');
            div.className = "photo-card";
            div.innerHTML = `<img src="${p.img}">`;
            div.onclick = () => {
                document.querySelectorAll('.photo-card').forEach(c => c.classList.remove('selected'));
                div.classList.add('selected');
                selectedTargetId = p.id;
                document.getElementById('btn-submit-vote').disabled = false;
            };
            grid.appendChild(div);
        });
    }

    function confirmVote() {
        if(!selectedTargetId) return;
        if(isHost) recordVote(peer.id, selectedTargetId);
        else conn.send({ type: 'SEND_VOTE', targetId: selectedTargetId });
        document.getElementById('btn-submit-vote').classList.add('hidden');
    }

    // å·¥å…·
    function setupLobby() {
        switchView('view-waiting');
        document.getElementById('display-room-id').innerText = roomId;
        
        // (1) (2) åå–®èˆ‡è¸¢äºº
        const listEl = document.getElementById('player-list');
        listEl.innerHTML = players.map(p => `
            <div class="player-row">
                <span>${p.name} ${p.id === roomId ? '(æˆ¿ä¸»)' : ''}</span>
                ${isHost && p.id !== peer.id ? `<button class="kick-btn" onclick="kickPlayer('${p.id}')">è¸¢å‡º</button>` : ''}
            </div>
        `).join('');

        document.getElementById('settings-preview').innerText = 
            `è¦å‰‡ï¼š${gameSettings.rounds}è¼ª | æ€è€ƒ${gameSettings.topicTime}s | ä¸Šå‚³${gameSettings.uploadTime}s`;

        if(isHost) document.getElementById('start-game-btn').classList.remove('hidden');
        else document.getElementById('waiting-msg').classList.remove('hidden');
    }

    function startTimer(sec, elId) {
        let t = sec;
        const el = document.getElementById(elId);
        clearInterval(timerInt);
        el.innerText = t;
        timerInt = setInterval(() => {
            t--; el.innerText = t;
            if(t <= 0) {
                clearInterval(timerInt);
                if(elId === 'game-timer' && document.getElementById('leader-input-area').className !== 'hidden' && !isHost) {
                   // é ˜è¢–è¶…æ™‚è‡ªå‹•ç™¼é€(å¯åŠ )
                }
            }
        }, 1000);
    }

    function previewImg(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById('p-img').src = e.target.result;
                document.getElementById('p-area').style.display = 'block';
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function switchView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }
    function showPhase(id) { document.getElementById(id).classList.remove('hidden'); }
    function copyId() { navigator.clipboard.writeText(roomId); alert("æˆ¿è™Ÿå·²è¤‡è£½ï¼"); }
    function randomName() { document.getElementById('player-name').value = ["ç›¸ç°¿é­”ç‹", "è‡ªæ‹é”äºº", "è·¯éçš„äºº", "æ”å½±å¤§å¸«"][Math.floor(Math.random()*4)]; }
</script>
</body>
</html>
