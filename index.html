<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èª°çš„ç›¸ç°¿? v0.6</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #00b894;
            --secondary-color: #00cec9;
            --bg-grad: linear-gradient(135deg, #2d3436 0%, #000000 100%);
            --card-bg: rgba(255, 255, 255, 0.1);
            --text-color: #dfe6e9;
            --accent-yellow: #fdcb6e;
            --danger-red: #ff7675;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Segoe UI', "Microsoft JhengHei", sans-serif;
            background: var(--bg-grad); color: var(--text-color);
            margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden;
        }

        .container { width: 100%; max-width: 480px; padding: 15px; text-align: center; }
        .card {
            background: var(--card-bg); backdrop-filter: blur(12px); border-radius: 24px;
            padding: 20px; border: 1px solid rgba(255,255,255,0.15); margin-top: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        h1 { background: linear-gradient(to right, var(--primary-color), var(--secondary-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 2.2rem; font-weight: 800; margin: 10px 0; }
        .hidden { display: none !important; }

        /* é€²åº¦æ¢ */
        .progress-container { width: 100%; background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; margin: 10px 0; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--primary-color); width: 100%; transition: width 1s linear; }

        /* è¨­å®šå½ˆçª— */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: #333; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; text-align: left; border: 1px solid var(--primary-color); }

        /* è¼¸å…¥èˆ‡é¸å–® */
        .input-group { display: flex; gap: 8px; margin-bottom: 12px; }
        input[type="text"], select { flex: 1; padding: 12px; background: rgba(0,0,0,0.3); border: 2px solid #555; border-radius: 12px; color: white; font-size: 1rem; }
        .dice-btn { background: #555; border: none; border-radius: 12px; color: white; padding: 0 15px; cursor: pointer; }

        button.main-btn { width: 100%; background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); color: #fff; border: none; padding: 16px; font-size: 1.1rem; border-radius: 14px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        
        /* åå–®æ¸…å–® */
        .player-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: rgba(255,255,255,0.05); border-radius: 12px; margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.1); }
        .kick-btn { background: var(--danger-red); border: none; color: white; padding: 5px 10px; border-radius: 8px; font-size: 0.8rem; }

        /* Emoji äº’å‹• */
        .emoji-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px 0; }
        .emoji-item { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 12px; font-size: 1.5rem; cursor: pointer; transition: 0.2s; }
        .emoji-item:active { transform: scale(0.9); background: rgba(255,255,255,0.15); }

        /* é–‹çå‹•ç•«ç›¸é—œ */
        .reveal-card { position: relative; border-radius: 15px; overflow: hidden; border: 3px solid transparent; transition: 0.5s; }
        .reveal-card.is-leader { border-color: var(--accent-yellow); box-shadow: 0 0 15px var(--accent-yellow); }
        .reveal-card.is-most-voted { border-color: var(--danger-red); }
        .badge { position: absolute; top: 5px; right: 5px; padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: bold; z-index: 2; }
        .badge-leader { background: var(--accent-yellow); color: #000; }
        .badge-most { background: var(--danger-red); color: #fff; }
        .owner-tag { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.7); color: white; font-size: 0.8rem; padding: 4px 0; }

        .timer-text { font-size: 2.5rem; font-weight: 800; color: var(--danger-red); margin: 0; }
        .version-tag { position: fixed; bottom: 8px; right: 12px; color: #444; font-size: 0.7rem; }
    </style>
</head>
<body>

<div class="container">
    <h1>èª°çš„ç›¸ç°¿?</h1>

    <div id="view-lobby" class="view">
        <div class="card">
            <h3>æ­¡è¿åŠ å…¥éŠæˆ²</h3>
            <div class="input-group">
                <input type="text" id="player-name" placeholder="è¼¸å…¥æš±ç¨±" maxlength="10">
                <button class="dice-btn" onclick="applyRandomName()"><i class="fas fa-dice"></i></button>
            </div>
            <button class="main-btn" onclick="showSettings()">å»ºç«‹æˆ¿é–“ (Host)</button>
            <div style="margin: 15px 0; opacity: 0.5;">- æˆ– -</div>
            <input type="text" id="room-id-input" placeholder="è²¼ä¸Šæˆ¿è™Ÿ ID" style="margin-bottom: 10px;">
            <button class="main-btn" style="background: #444;" onclick="joinRoom()">åŠ å…¥æˆ¿é–“</button>
        </div>
    </div>

    <div id="modal-settings" class="modal hidden">
        <div class="modal-content">
            <h3 style="margin-top:0; color:var(--primary-color)">æˆ¿é–“é€²éšè¨­å®š</h3>
            <label>éŠæˆ²è¼ªæ•¸ (æ¯äººç•¶å¹¾æ¬¡é ˜è¢–)</label>
            <select id="set-rounds">
                <option value="1">1 è¼ª</option>
                <option value="2" selected>2 è¼ª (æ¨è–¦)</option>
                <option value="3">3 è¼ª</option>
            </select>
            <label>é ˜è¢–æ€è€ƒæ™‚é–“ (ç§’)</label>
            <select id="set-topic-time">
                <option value="15">15</option>
                <option value="20" selected>20</option>
                <option value="40">40</option>
            </select>
            <label>ç©å®¶é¸æ“‡ç…§ç‰‡æ™‚é–“ (ç§’)</label>
            <select id="set-upload-time">
                <option value="30">30</option>
                <option value="50" selected>50</option>
                <option value="90">90</option>
            </select>
            <button class="main-btn" onclick="createRoom()">å®Œæˆä¸¦é–‹å•Ÿæˆ¿é–“</button>
            <button class="main-btn" style="background:transparent; color:#888;" onclick="hideSettings()">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="view-waiting" class="view hidden">
        <div class="card">
            <div style="font-size:0.8rem; color:#888">æˆ¿è™Ÿ (é»æ“Šè¤‡è£½)</div>
            <div style="font-size: 1.5rem; color: var(--accent-yellow); cursor: pointer;" onclick="copyId()" id="display-room-id">...</div>
            
            <div id="player-list" style="margin: 20px 0;"></div>
            
            <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                <div style="font-size:0.8rem; color:#888">äº’å‹•ç‰† (é»æ“ŠåŒæ­¥)</div>
                <div class="emoji-grid">
                    <div id="e1" class="emoji-item" onclick="hitEmoji(1)">ğŸ”¥</div>
                    <div id="e2" class="emoji-item" onclick="hitEmoji(2)">ğŸ˜</div>
                    <div id="e3" class="emoji-item" onclick="hitEmoji(3)">ğŸº</div>
                    <div id="e4" class="emoji-item" onclick="hitEmoji(4)">ğŸ‘»</div>
                </div>
            </div>

            <button id="start-game-btn" class="main-btn hidden" onclick="hostStartGame()">å…¨å“¡å‡ºç™¼</button>
            <p id="waiting-msg" class="hidden">ç­‰å¾…æˆ¿ä¸»é–‹å§‹...</p>
        </div>
    </div>

    <div id="view-game" class="view hidden">
        <div class="card">
            <div id="phase-action" class="phase">
                <p id="leader-msg" style="color:var(--accent-yellow); margin-bottom:5px;"></p>
                <h2 id="topic-display" style="color:var(--secondary-color)">ç­‰å¾…...</h2>
                <div class="progress-container"><div id="action-bar" class="progress-bar"></div></div>
                <p class="timer-text" id="action-timer">--</p>
                
                <div id="leader-input-area" class="hidden">
                    <input type="text" id="topic-input" placeholder="è¼¸å…¥é¡Œç›®ï¼Œå¦‚ï¼šæœ€åƒä¸Šç­æ—çš„å‹•ç‰©">
                    <button class="main-btn" onclick="submitTopic()">ç™¼å¸ƒé¡Œç›®</button>
                </div>

                <div id="player-upload-area" class="hidden">
                    <label for="photo-input" style="display:block; padding:30px; border:2px dashed #555; border-radius:15px; cursor:pointer;">
                        <i class="fas fa-cloud-upload-alt" style="font-size:2rem; margin-bottom:10px"></i>
                        <p>é¸æ“‡ç…§ç‰‡</p>
                    </label>
                    <input type="file" id="photo-input" accept="image/*" style="display:none" onchange="previewImg(this)">
                    <div id="p-area" style="display:none; margin:15px 0;"><img id="p-img" style="width:120px; height:120px; border-radius:10px; object-fit:cover"></div>
                    <button class="main-btn" id="btn-upload" onclick="uploadImg()">ç¢ºèªä¸Šå‚³</button>
                </div>
                <div id="wait-others-msg" class="hidden"><p><i class="fas fa-check"></i> å·²æº–å‚™å°±ç·’</p></div>
            </div>

            <div id="phase-voting" class="phase hidden">
                <h3 id="vote-prompt"></h3>
                <div class="progress-container"><div id="vote-bar" class="progress-bar"></div></div>
                <p class="timer-text" id="vote-timer">--</p>
                <div style="max-height: 45vh; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 15px; padding: 10px;">
                    <div class="photo-grid" id="voting-grid"></div>
                </div>
                <button class="main-btn" id="btn-submit-vote" onclick="confirmVote()" disabled>ç¢ºå®šæŠ•ç¥¨</button>
            </div>

            <div id="phase-reveal" class="phase hidden">
                <h3 style="color:var(--accent-yellow)">æ­æ›‰çµæœ</h3>
                <div class="photo-grid" id="reveal-grid"></div>
                <p style="margin-top:15px; font-size:0.9rem; color:#888;">æ­£åœ¨è¨ˆç®—å¾—åˆ†...</p>
            </div>

            <div id="phase-results" class="phase hidden">
                <h3>å›åˆç©åˆ†æ¦œ</h3>
                <div id="round-scores" style="text-align:left;"></div>
            </div>
        </div>
    </div>

    <div id="view-final" class="view hidden">
        <div class="card">
            <h2 style="color:var(--accent-yellow)">ğŸ† éŠæˆ²çµæŸ ğŸ†</h2>
            <div id="final-list" style="text-align:left;"></div>
            <button class="main-btn" onclick="location.reload()">å›é¦–é </button>
        </div>
    </div>
</div>

<div class="version-tag">v0.6 | æ­æ›‰å‹•ç•«èˆ‡é€²åº¦æ¢</div>

<script>
    // --- (5) éš¨æ©Ÿåç¨±æ¸…å–® ---
    const funnyNames = ["å°åŒ—æ—å…‹", "ç›¸ç°¿çµäºº", "è‡ªæ‹é«˜æ‰‹", "æ·±å¤œæ”å½±å¸«", "è¿·è·¯çš„å°è±¬", "è¥¿é–€å¹é›ª", "è·¯é‚Šçš„è€ç‹", "è‰è“å¸ƒä¸", "ç¥ç§˜å˜‰è³“"];
    
    let peer, conn, roomId;
    let myName = "";
    let isHost = false;
    let players = [];
    let currentLeaderId = "";
    let selectedTargetId = null;
    let timerInt;
    let gameSettings = { rounds: 2, topicTime: 20, uploadTime: 50 };

    // åˆå§‹åŒ–éš¨æ©Ÿåå­—
    window.onload = () => { applyRandomName(); };
    function applyRandomName() {
        document.getElementById('player-name').value = funnyNames[Math.floor(Math.random() * funnyNames.length)];
    }

    // --- è¨­å®šèˆ‡æˆ¿ä¸»æµç¨‹ ---
    function showSettings() {
        myName = document.getElementById('player-name').value.trim();
        if(!myName) return alert("è«‹è¼¸å…¥æš±ç¨±");
        document.getElementById('modal-settings').classList.remove('hidden');
    }
    function hideSettings() { document.getElementById('modal-settings').classList.add('hidden'); }

    function createRoom() {
        gameSettings.rounds = parseInt(document.getElementById('set-rounds').value);
        gameSettings.topicTime = parseInt(document.getElementById('set-topic-time').value);
        gameSettings.uploadTime = parseInt(document.getElementById('set-upload-time').value);
        hideSettings();
        
        peer = new Peer();
        peer.on('open', id => {
            isHost = true; roomId = id;
            players = [{ id: id, name: myName, score: 0, photo: null, votes: 0, voted: false }];
            setupLobby();
        });
        peer.on('connection', c => {
            c.on('open', () => {
                c.on('data', data => handleHostRecv(data, c));
                c.send({ type: 'SYNC_SETTINGS', settings: gameSettings });
            });
        });
    }

    function joinRoom() {
        myName = document.getElementById('player-name').value.trim();
        let targetId = document.getElementById('room-id-input').value.trim();
        if(!myName || !targetId) return alert("è«‹å¡«å¯«åå­—èˆ‡æˆ¿è™Ÿ");
        peer = new Peer();
        peer.on('open', id => {
            conn = peer.connect(targetId);
            conn.on('open', () => {
                conn.send({ type: 'JOIN', name: myName });
                roomId = targetId;
            });
            conn.on('data', data => handleClientRecv(data));
        });
    }

    // --- Emoji åŒæ­¥ ---
    const emojiPool = ["ğŸ”¥", "ğŸ˜", "ğŸº", "ğŸ‘»", "ğŸ’", "ğŸŒˆ", "ğŸ•", "ğŸš€", "ğŸ¦„", "ğŸ¸", "ğŸ¦"];
    function hitEmoji(slot) {
        if(isHost) handleEmojiLogic(slot);
        else if(conn) conn.send({ type: 'EMOJI_HIT', slot: slot });
    }
    function handleEmojiLogic(slot) {
        let next = emojiPool[Math.floor(Math.random()*emojiPool.length)];
        broadcast({ type: 'EMOJI_SYNC', slot: slot, emoji: next });
        document.getElementById('e'+slot).innerText = next;
    }

    function kickPlayer(peerId) {
        if(!isHost) return;
        const target = players.find(p => p.id === peerId);
        if(target && target.conn) {
            target.conn.send({ type: 'KICKED' });
            setTimeout(() => target.conn.close(), 500);
        }
        players = players.filter(p => p.id !== peerId);
        broadcastLobby(); setupLobby();
    }

    // --- è¨Šæ¯æ ¸å¿ƒ ---
    function handleHostRecv(data, c) {
        switch(data.type) {
            case 'JOIN':
                if(players.some(p => p.id === c.peer)) return;
                players.push({ id: c.peer, name: data.name, score: 0, photo: null, votes: 0, voted: false, conn: c });
                broadcastLobby(); setupLobby();
                break;
            case 'EMOJI_HIT': handleEmojiLogic(data.slot); break;
            case 'SEND_TOPIC': startUpload(data.topic); break;
            case 'SEND_PHOTO':
                let p = players.find(x => x.id === c.peer);
                if(p) p.photo = data.photo;
                checkAllUploads();
                break;
            case 'SEND_VOTE': recordVote(c.peer, data.targetId); break;
        }
    }

    function handleClientRecv(data) {
        switch(data.type) {
            case 'KICKED': alert("ä½ å·²è¢«ç§»å‡ºæˆ¿é–“"); location.reload(); break;
            case 'SYNC_SETTINGS': gameSettings = data.settings; break;
            case 'LOBBY_DATA': players = data.list; setupLobby(); break;
            case 'EMOJI_SYNC': document.getElementById('e'+data.slot).innerText = data.emoji; break;
            case 'STATE_SYNC': renderState(data); break;
        }
    }

    function broadcastLobby() { broadcast({ type: 'LOBBY_DATA', list: players.map(p => ({id: p.id, name: p.name})) }); }
    function broadcast(msg) { players.forEach(p => { if(p.conn && p.conn.open) p.conn.send(msg); }); }

    // --- éŠæˆ²é‚è¼¯ ---
    function hostStartGame() {
        if(players.length < 3) return alert("è‡³å°‘éœ€ 3 äºº");
        nextRound(0);
    }

    function nextRound(roundIdx) {
        const maxR = players.length * gameSettings.rounds;
        if(roundIdx >= maxR) {
            broadcastState('FINAL', { players: players.map(p => ({name:p.name, score:p.score})) });
            return;
        }
        players.forEach(p => { p.photo = null; p.votes = 0; p.voted = false; p.pickedByLeader = false; });
        const leader = players[roundIdx % players.length];
        currentLeaderId = leader.id;
        broadcastState('WAIT_TOPIC', { leaderId: leader.id, leaderName: leader.name, round: roundIdx });
    }

    function startUpload(topic) { broadcastState('UPLOADING', { topic: topic, leaderId: currentLeaderId }); }

    function checkAllUploads() {
        const ups = players.filter(p => p.id !== currentLeaderId);
        if(ups.every(p => p.photo)) {
            const pool = ups.map(p => ({id: p.id, img: p.photo})).sort(() => Math.random() - 0.5);
            broadcastState('VOTING', { photos: pool, leaderId: currentLeaderId });
        }
    }

    function recordVote(vId, tId) {
        let voter = players.find(p => p.id === vId);
        if(!voter || voter.voted) return;
        voter.voted = true;

        let target = players.find(p => p.id === tId);
        if(vId === currentLeaderId) {
            if(target) { target.score += 2; target.pickedByLeader = true; }
        } else {
            if(target) target.votes += 1;
        }

        if(players.every(p => p.voted)) {
            const others = players.filter(p => p.id !== currentLeaderId);
            const maxV = Math.max(...others.map(o => o.votes));
            if(maxV > 0) {
                others.forEach(o => { if(o.votes === maxV) o.score = Math.max(0, o.score - 1); });
            }
            
            // --- (6) å…ˆé€²å…¥æ­æ›‰éšæ®µ ---
            const revealData = players.filter(p => p.id !== currentLeaderId).map(p => ({
                name: p.name, photo: p.photo, votes: p.votes, isLeaderPick: p.pickedByLeader, isMostVoted: (p.votes === maxV && maxV > 0)
            }));
            broadcastState('REVEAL', { list: revealData });
            
            setTimeout(() => {
                broadcastState('RESULTS', { players: players.map(p => ({name:p.name, score:p.score})) });
                setTimeout(() => {
                    let curR = parseInt(document.body.dataset.round || 0);
                    nextRound(curR + 1);
                }, 4000);
            }, 6000); // æ­æ›‰åœç•™ 6 ç§’
        }
    }

    function broadcastState(phase, payload) {
        document.body.dataset.round = payload.round !== undefined ? payload.round : (document.body.dataset.round || 0);
        const state = { type: 'STATE_SYNC', phase: phase, ...payload };
        renderState(state);
        broadcast(state);
    }

    // --- UI èˆ‡é€²åº¦æ¢ ---
    function renderState(data) {
        switchView('view-game');
        document.querySelectorAll('.phase').forEach(p => p.classList.add('hidden'));
        
        if(data.phase === 'WAIT_TOPIC') {
            showPhase('phase-action');
            document.getElementById('topic-display').innerText = "é ˜è¢–æ­£åœ¨æ€è€ƒé¡Œç›®...";
            document.getElementById('leader-input-area').classList.toggle('hidden', peer.id !== data.leaderId);
            document.getElementById('player-upload-area').classList.add('hidden');
            document.getElementById('leader-msg').innerText = peer.id === data.leaderId ? "ä½ æ˜¯é ˜è¢–" : "é ˜è¢–ï¼š" + data.leaderName;
            document.getElementById('wait-others-msg').classList.add('hidden');
            startTimer(gameSettings.topicTime, 'action-timer', 'action-bar');
        }
        else if(data.phase === 'UPLOADING') {
            showPhase('phase-action');
            document.getElementById('topic-display').innerText = data.topic;
            document.getElementById('leader-input-area').classList.add('hidden');
            startTimer(gameSettings.uploadTime, 'action-timer', 'action-bar');
            if(peer.id === data.leaderId) {
                document.getElementById('player-upload-area').classList.add('hidden');
                document.getElementById('wait-others-msg').classList.remove('hidden');
            } else {
                document.getElementById('player-upload-area').classList.remove('hidden');
                document.getElementById('wait-others-msg').classList.add('hidden');
                document.getElementById('p-area').style.display = 'none';
            }
        }
        else if(data.phase === 'VOTING') {
            showPhase('phase-voting');
            startTimer(20, 'vote-timer', 'vote-bar');
            document.getElementById('vote-prompt').innerText = (peer.id === data.leaderId) ? "é¸æ“‡æœ€ç¬¦åˆçš„ (+2åˆ†)" : "é¸æ“‡æœ€ä¸ç¬¦åˆçš„ (-1åˆ†)";
            renderGrid(data.photos);
            document.getElementById('btn-submit-vote').disabled = true;
            document.getElementById('btn-submit-vote').classList.remove('hidden');
        }
        else if(data.phase === 'REVEAL') {
            showPhase('phase-reveal');
            renderReveal(data.list);
        }
        else if(data.phase === 'RESULTS') {
            showPhase('phase-results');
            const html = data.players.sort((a,b)=>b.score-a.score).map(p => `
                <div class="player-row"><span>${p.name}</span><b>${p.score} åˆ†</b></div>`).join('');
            document.getElementById('round-scores').innerHTML = html;
        }
        else if(data.phase === 'FINAL') {
            switchView('view-final');
            const html = data.players.sort((a,b)=>b.score-a.score).map((p,i) => `<div class="player-row"><span>#${i+1} ${p.name}</span><b>${p.score}åˆ†</b></div>`).join('');
            document.getElementById('final-list').innerHTML = html;
        }
    }

    function startTimer(sec, textId, barId) {
        let t = sec;
        const textEl = document.getElementById(textId);
        const barEl = document.getElementById(barId);
        clearInterval(timerInt);
        textEl.innerText = t;
        barEl.style.transition = 'none';
        barEl.style.width = '100%';
        setTimeout(() => {
            barEl.style.transition = `width ${sec}s linear`;
            barEl.style.width = '0%';
        }, 50);
        timerInt = setInterval(() => {
            t--; textEl.innerText = t;
            if(t <= 0) clearInterval(timerInt);
        }, 1000);
    }

    function renderGrid(photos) {
        const grid = document.getElementById('voting-grid'); grid.innerHTML = "";
        photos.forEach(p => {
            const div = document.createElement('div'); div.className = "photo-card";
            div.style = "aspect-ratio:1/1; overflow:hidden; border-radius:12px; border:4px solid transparent;";
            div.innerHTML = `<img src="${p.img}" style="width:100%; height:100%; object-fit:cover">`;
            div.onclick = () => {
                document.querySelectorAll('.photo-card').forEach(c => c.style.borderColor = 'transparent');
                div.style.borderColor = 'var(--accent-yellow)';
                selectedTargetId = p.id;
                document.getElementById('btn-submit-vote').disabled = false;
            };
            grid.appendChild(div);
        });
    }

    function renderReveal(list) {
        const grid = document.getElementById('reveal-grid'); grid.innerHTML = "";
        list.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = `reveal-card ${item.isLeaderPick ? 'is-leader' : ''} ${item.isMostVoted ? 'is-most-voted' : ''}`;
            div.style.opacity = "0";
            div.style.transform = "translateY(20px)";
            div.innerHTML = `
                <img src="${item.photo}" style="width:100%; aspect-ratio:1/1; object-fit:cover;">
                <div class="owner-tag">${item.name}</div>
                ${item.isLeaderPick ? '<div class="badge badge-leader">é ˜è¢–æœ€æ„›</div>' : ''}
                ${item.isMostVoted ? '<div class="badge badge-most">æœ€ä¸ç¬¦åˆ</div>' : ''}
            `;
            grid.appendChild(div);
            // é€ä¸€é¡¯ç¤ºå‹•ç•«
            setTimeout(() => {
                div.style.opacity = "1";
                div.style.transform = "translateY(0)";
            }, idx * 800);
        });
    }

    function submitTopic() {
        const t = document.getElementById('topic-input').value.trim();
        if(!t) return;
        if(isHost) startUpload(t); else conn.send({ type: 'SEND_TOPIC', topic: t });
    }

    function uploadImg() {
        const file = document.getElementById('photo-input').files[0];
        if(!file) return alert("é¸å¼µç…§ç‰‡å§");
        const reader = new FileReader();
        reader.onload = e => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                const scale = Math.min(500/img.width, 500/img.height);
                canvas.width = img.width * scale; canvas.height = img.height * scale;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                if(isHost) { players.find(p=>p.id===peer.id).photo = dataUrl; checkAllUploads(); }
                else conn.send({ type: 'SEND_PHOTO', photo: dataUrl });
                document.getElementById('player-upload-area').classList.add('hidden');
                document.getElementById('wait-others-msg').classList.remove('hidden');
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function confirmVote() {
        if(!selectedTargetId) return;
        if(isHost) recordVote(peer.id, selectedTargetId); else conn.send({ type: 'SEND_VOTE', targetId: selectedTargetId });
        document.getElementById('btn-submit-vote').classList.add('hidden');
    }

    function setupLobby() {
        switchView('view-waiting');
        document.getElementById('display-room-id').innerText = roomId;
        const listEl = document.getElementById('player-list');
        listEl.innerHTML = players.map(p => `
            <div class="player-row">
                <span>${p.name} ${p.id === roomId ? 'ğŸ‘‘' : ''}</span>
                ${isHost && p.id !== peer.id ? `<button class="kick-btn" onclick="kickPlayer('${p.id}')">è¸¢å‡º</button>` : ''}
            </div>`).join('');
        if(isHost) document.getElementById('start-game-btn').classList.remove('hidden');
        else document.getElementById('waiting-msg').classList.remove('hidden');
    }

    function copyId() { navigator.clipboard.writeText(roomId); alert("æˆ¿è™Ÿå·²è¤‡è£½ï¼"); }
    function switchView(id) { document.querySelectorAll('.view').forEach(v => v.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
    function showPhase(id) { document.getElementById(id).classList.remove('hidden'); }
    function previewImg(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => { document.getElementById('p-img').src = e.target.result; document.getElementById('p-area').style.display = 'block'; };
            reader.readAsDataURL(input.files[0]);
        }
    }
</script>
</body>
</html>
