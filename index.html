<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èª°çš„ç›¸ç°¿? v0.4</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #00b894;
            --secondary-color: #00cec9;
            --bg-grad: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            --card-bg: rgba(255, 255, 255, 0.08);
            --text-color: #e9ecef;
            --accent-yellow: #feca57;
            --danger-red: #ff6b6b;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Segoe UI', "Microsoft JhengHei", sans-serif;
            background: var(--bg-grad);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container { width: 100%; max-width: 480px; padding: 15px; text-align: center; }

        .card {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border-radius: 24px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            margin-top: 15px;
        }

        h1 { 
            background: linear-gradient(to right, #55efc4, #81ecec);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2.4rem; font-weight: 900; margin: 10px 0;
        }

        .hidden { display: none !important; }

        /* è¼¸å…¥çµ„ä»¶ */
        .input-group { position: relative; display: flex; align-items: center; gap: 8px; }
        input[type="text"] {
            flex: 1; padding: 15px; background: rgba(0,0,0,0.3);
            border: 2px solid #444; border-radius: 12px; color: white;
            font-size: 1rem; text-align: center; outline: none;
        }
        .random-btn { 
            background: #444; color: white; border: none; padding: 12px; 
            border-radius: 12px; cursor: pointer; font-size: 1.2rem;
        }

        button.main-btn {
            width: 100%; background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: #fff; border: none; padding: 16px; font-size: 1.1rem;
            border-radius: 14px; cursor: pointer; font-weight: bold; margin-top: 10px;
            box-shadow: 0 4px 20px rgba(0,184,148,0.3);
        }

        /* æˆ¿è™Ÿèˆ‡è¤‡è£½ */
        .room-display { font-size: 1.8rem; color: var(--accent-yellow); font-family: monospace; display: flex; align-items: center; justify-content: center; gap: 12px; }
        
        /* äº’å‹• Emoji ç‰† */
        .emoji-wall { display: flex; justify-content: center; gap: 15px; margin: 20px 0; }
        .emoji-btn { 
            font-size: 2.2rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            padding: 10px; border-radius: 15px; cursor: pointer; transition: 0.2s;
        }
        .emoji-btn:hover { background: rgba(255,255,255,0.15); transform: translateY(-3px); }

        /* ç…§ç‰‡ç‰†èˆ‡æ»¾å‹• */
        .scroll-box { max-height: 50vh; overflow-y: auto; border-radius: 15px; background: rgba(0,0,0,0.2); padding: 10px; }
        .photo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .photo-card { aspect-ratio: 1/1; border-radius: 12px; overflow: hidden; border: 4px solid transparent; cursor: pointer; position: relative; }
        .photo-card img { width: 100%; height: 100%; object-fit: cover; }
        .photo-card.selected { border-color: var(--accent-yellow); box-shadow: 0 0 15px var(--accent-yellow); }

        .timer { font-size: 3rem; font-weight: 800; color: var(--danger-red); margin: 5px 0; }
        .status-pill { background: rgba(0,184,148,0.15); padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; border: 1px solid var(--primary-color); margin: 3px; }
        .version-tag { position: fixed; bottom: 8px; right: 12px; color: #444; font-size: 0.75rem; }
    </style>
</head>
<body>

<div class="container">
    <h1>èª°çš„ç›¸ç°¿?</h1>

    <div id="view-lobby" class="view">
        <div class="card">
            <h3>æº–å‚™åƒåŠ æ´¾å°</h3>
            <div class="input-group">
                <input type="text" id="player-name" placeholder="è¼¸å…¥æš±ç¨±" maxlength="10">
                <button class="random-btn" onclick="randomName()" title="éš¨æ©Ÿå–å"><i class="fas fa-dice"></i></button>
            </div>
            <button class="main-btn" id="btn-create" onclick="createRoom()">å»ºç«‹æˆ¿é–“ (Host)</button>
            <div style="margin: 15px 0; opacity: 0.5;">æˆ–</div>
            <input type="text" id="room-id-input" placeholder="è²¼ä¸Šæˆ¿è™Ÿ ID">
            <button class="main-btn" id="btn-join" onclick="joinRoom()">åŠ å…¥æˆ¿é–“</button>
        </div>
    </div>

    <div id="view-waiting" class="view hidden">
        <div class="card">
            <div class="room-display">
                <span id="display-room-id">...</span>
                <i class="fas fa-copy" style="font-size:1.2rem; cursor:pointer; color:#777" onclick="copyId()"></i>
            </div>
            <p>å·²é€£æ¥ (<span id="player-count">0</span>/6)</p>
            <div id="player-list"></div>
            
            <div class="emoji-wall">
                <div id="e1" class="emoji-btn" onclick="hitEmoji(1)">ğŸŒ²</div>
                <div id="e2" class="emoji-btn" onclick="hitEmoji(2)">ğŸ“·</div>
                <div id="e3" class="emoji-btn" onclick="hitEmoji(3)">ğŸº</div>
            </div>
            <p style="font-size:0.8rem; color:#666">é»æ“Šä¸Šé¢åœ–æ¡ˆæœƒåŒæ­¥æ”¹è®Šå–”ï¼</p>

            <button id="start-game-btn" class="main-btn hidden" onclick="hostStartGame()">å…¨é«”å‡ºç™¼ï¼</button>
            <p id="waiting-msg" class="hidden">æˆ¿ä¸»æ­£åœ¨æª¢æŸ¥å¤§å®¶çš„æ‰‹æ©Ÿ...</p>
        </div>
    </div>

    <div id="view-game" class="view hidden">
        <div class="card">
            <div id="phase-action" class="phase">
                <p id="leader-msg" style="color:var(--accent-yellow)"></p>
                <h2 id="topic-display" style="color:var(--primary-color)">ç­‰å¾…é ˜è¢–å‡ºé¡Œ...</h2>
                <div class="timer" id="game-timer">--</div>
                
                <div id="leader-input-area" class="hidden">
                    <input type="text" id="topic-input" placeholder="ä¾‹å¦‚ï¼šé€™å¼µç…§ç‰‡çœ‹èµ·ä¾†å¾ˆè²´">
                    <button class="main-btn" onclick="submitTopic()">ç™¼å¸ƒé¡Œç›®</button>
                </div>

                <div id="player-upload-area" class="hidden">
                    <label for="photo-input" style="display:block; padding:30px; border:2px dashed #555; border-radius:15px; cursor:pointer;">
                        <i class="fas fa-cloud-upload-alt" style="font-size:2rem; margin-bottom:10px"></i>
                        <p>é»æˆ‘é¸æ“‡ç…§ç‰‡</p>
                    </label>
                    <input type="file" id="photo-input" accept="image/*" style="display:none" onchange="previewImg(this)">
                    <div id="p-area" style="display:none; margin:10px 0;">
                        <img id="p-img" style="width:120px; height:120px; border-radius:10px; object-fit:cover">
                    </div>
                    <button class="main-btn" id="btn-upload" onclick="uploadImg()">ç¢ºèªä¸Šå‚³ç…§ç‰‡</button>
                </div>

                <div id="wait-others-msg" class="hidden">
                    <i class="fas fa-hourglass-half" style="color:var(--accent-yellow)"></i>
                    <p>å·²å®Œæˆï¼Œç­‰å¾…å…¶ä»–ç©å®¶ä¸­...</p>
                </div>
            </div>

            <div id="phase-voting" class="phase hidden">
                <h3 id="vote-prompt"></h3>
                <div class="timer" id="vote-timer">--</div>
                <div class="scroll-box">
                    <div class="photo-grid" id="voting-grid"></div>
                </div>
                <button class="main-btn" id="btn-submit-vote" onclick="confirmVote()" disabled>ç¢ºå®šæŠ•ç¥¨</button>
            </div>

            <div id="phase-results" class="phase hidden">
                <h3>æœ¬å›åˆå¾—åˆ†</h3>
                <div id="round-scores" style="line-height:2.2; text-align:left;"></div>
            </div>
        </div>
    </div>

    <div id="view-final" class="view hidden">
        <div class="card">
            <h2 style="color:var(--accent-yellow)">ğŸ† ç¸½æ±ºç®— ğŸ†</h2>
            <div id="final-list" style="text-align:left; margin-bottom:20px;"></div>
            <button class="main-btn" onclick="location.reload()">å›é¦–é </button>
        </div>
    </div>
</div>

<div class="version-tag">v0.4 | ä¿®æ­£è¨ˆåˆ†èˆ‡åŒæ­¥</div>

<script>
    // --- (4) éš¨æ©Ÿåç¨±æ¸…å–® ---
    const funnyNames = ["æ·¡æ°´é‡‘åŸæ­¦", "å¤§å®‰å‘¨æ°å€«", "è¥¿é–€ç”ºæœ€å¸¥", "éš”å£è€ç‹", "é€™äººå¾ˆæ‡¶", "ç›¸ç°¿æ”¶è—å®¶", "ç…§ç‰‡æˆ°å£«", "ç¶ è‰²å°ç²¾éˆ", "æ´¾å°ä¹‹ç‹"];
    
    let peer, conn, roomId;
    let myName = "";
    let isHost = false;
    let players = [];
    let currentLeaderId = "";
    let selectedTargetId = null;
    let timerInt;

    // --- åˆå§‹åŒ–åŠŸèƒ½ ---
    function randomName() {
        document.getElementById('player-name').value = funnyNames[Math.floor(Math.random()*funnyNames.length)];
    }

    function createRoom() {
        myName = document.getElementById('player-name').value.trim();
        if(!myName) return alert("è«‹è¼¸å…¥æš±ç¨±");
        document.getElementById('btn-create').disabled = true;
        
        peer = new Peer();
        peer.on('open', id => {
            isHost = true;
            roomId = id;
            players = [{ id: id, name: myName, score: 0, photo: null, votes: 0, voted: false }];
            setupLobby();
        });
        peer.on('connection', c => {
            c.on('open', () => {
                c.on('data', data => handleHostRecv(data, c));
            });
        });
    }

    function joinRoom() {
        myName = document.getElementById('player-name').value.trim();
        let targetId = document.getElementById('room-id-input').value.trim();
        if(!myName || !targetId) return alert("æš±ç¨±èˆ‡æˆ¿è™Ÿéƒ½è¦å¡«å–”");

        peer = new Peer();
        peer.on('open', id => {
            conn = peer.connect(targetId);
            conn.on('open', () => {
                conn.send({ type: 'JOIN', name: myName });
                roomId = targetId;
            });
            conn.on('data', data => handleClientRecv(data));
        });
    }

    // --- åŒæ­¥äº’å‹• (Emoji) ---
    const emojiMap = ["ğŸŒ²", "ğŸ“·", "ğŸº", "ğŸ€", "ğŸ”¥", "ğŸ’", "ğŸ‘»", "ğŸ¦„", "ğŸŒˆ"];
    function hitEmoji(slot) {
        const data = { type: 'EMOJI_HIT', slot: slot };
        if(isHost) handleEmojiLogic(slot);
        else conn.send(data);
    }

    function handleEmojiLogic(slot) {
        let el = document.getElementById('e' + slot);
        let nextEmoji = emojiMap[Math.floor(Math.random()*emojiMap.length)];
        broadcast({ type: 'EMOJI_SYNC', slot: slot, emoji: nextEmoji });
        el.innerText = nextEmoji; // Host è‡ªå·±è®Š
    }

    // --- è¨Šæ¯æ ¸å¿ƒ ---
    function handleHostRecv(data, c) {
        switch(data.type) {
            case 'JOIN':
                if(players.some(p => p.id === c.peer)) return;
                players.push({ id: c.peer, name: data.name, score: 0, photo: null, votes: 0, voted: false, conn: c });
                broadcast({ type: 'LOBBY_DATA', list: players.map(p => ({name:p.name})) });
                setupLobby();
                break;
            case 'EMOJI_HIT': handleEmojiLogic(data.slot); break;
            case 'SEND_TOPIC': startUpload(data.topic); break;
            case 'SEND_PHOTO':
                let p = players.find(x => x.id === c.peer);
                if(p) p.photo = data.photo;
                checkAllUploads();
                break;
            case 'SEND_VOTE': recordVote(c.peer, data.targetId); break;
        }
    }

    function handleClientRecv(data) {
        switch(data.type) {
            case 'LOBBY_DATA':
                players = data.list;
                setupLobby();
                break;
            case 'EMOJI_SYNC':
                document.getElementById('e'+data.slot).innerText = data.emoji;
                break;
            case 'STATE_SYNC':
                renderState(data);
                break;
        }
    }

    function broadcast(msg) {
        players.forEach(p => { if(p.conn && p.conn.open) p.conn.send(msg); });
    }

    // --- éŠæˆ²é‚è¼¯ ---
    function hostStartGame() {
        if(players.length < 3) return alert("è‡³å°‘éœ€è¦ 3 ä½ç©å®¶");
        nextRound(0);
    }

    function nextRound(roundIdx) {
        const maxRounds = players.length * 2;
        if(roundIdx >= maxRounds) {
            broadcastState('FINAL', { players: players.map(p => ({name:p.name, score:p.score})) });
            return;
        }
        players.forEach(p => { p.photo = null; p.votes = 0; p.voted = false; });
        const leader = players[roundIdx % players.length];
        currentLeaderId = leader.id;
        broadcastState('WAIT_TOPIC', { leaderId: leader.id, leaderName: leader.name, round: roundIdx });
    }

    function startUpload(topic) {
        broadcastState('UPLOADING', { topic: topic, leaderId: currentLeaderId });
    }

    function checkAllUploads() {
        const uploaders = players.filter(p => p.id !== currentLeaderId);
        if(uploaders.every(p => p.photo)) {
            const pool = uploaders.map(p => ({id: p.id, img: p.photo})).sort(() => Math.random() - 0.5);
            broadcastState('VOTING', { photos: pool, leaderId: currentLeaderId });
        }
    }

    function recordVote(vId, tId) {
        let voter = players.find(p => p.id === vId);
        if(!voter || voter.voted) return;
        voter.voted = true;

        if(vId === currentLeaderId) {
            let target = players.find(p => p.id === tId);
            if(target) target.score += 2;
        } else {
            let target = players.find(p => p.id === tId);
            if(target) target.votes += 1;
        }

        if(players.every(p => p.voted)) {
            // (2) ä¿®æ­£æ‰£åˆ†é‚è¼¯
            const others = players.filter(p => p.id !== currentLeaderId);
            const maxV = Math.max(...others.map(o => o.votes));
            if(maxV > 0) {
                // æ‰€æœ‰å¾—åˆ°æœ€é«˜ç¥¨çš„äººéƒ½æ‰£ä¸€åˆ†
                others.forEach(o => {
                    if(o.votes === maxV) o.score = Math.max(0, o.score - 1);
                });
            }
            broadcastState('RESULTS', { players: players.map(p => ({name:p.name, score:p.score})) });
            setTimeout(() => {
                let currentR = parseInt(document.body.dataset.round || 0);
                nextRound(currentR + 1);
            }, 5000);
        }
    }

    function broadcastState(phase, payload) {
        document.body.dataset.round = payload.round !== undefined ? payload.round : (document.body.dataset.round || 0);
        const state = { type: 'STATE_SYNC', phase: phase, ...payload };
        renderState(state);
        broadcast(state);
    }

    // --- UI æ§åˆ¶ ---
    function renderState(data) {
        switchView('view-game');
        document.querySelectorAll('.phase').forEach(p => p.classList.add('hidden'));
        
        if(data.phase === 'WAIT_TOPIC') {
            showPhase('phase-action');
            document.getElementById('topic-display').innerText = "é ˜è¢–æ­£åœ¨æ€è€ƒé¡Œç›®...";
            document.getElementById('leader-input-area').classList.toggle('hidden', peer.id !== data.leaderId);
            document.getElementById('player-upload-area').classList.add('hidden');
            document.getElementById('leader-msg').innerText = peer.id === data.leaderId ? "ä½ æ˜¯é ˜è¢–" : "é ˜è¢–æ˜¯ " + data.leaderName;
            document.getElementById('wait-others-msg').classList.add('hidden');
        }
        else if(data.phase === 'UPLOADING') {
            showPhase('phase-action');
            document.getElementById('topic-display').innerText = "é¡Œç›®ï¼š" + data.topic;
            document.getElementById('leader-input-area').classList.add('hidden');
            
            // (1) ä¿®æ­£è¦é ˜è¢–ä¹Ÿè¦çœ‹åˆ°è¨ˆæ™‚
            startTimer(50, 'game-timer');

            if(peer.id === data.leaderId) {
                document.getElementById('player-upload-area').classList.add('hidden');
                document.getElementById('wait-others-msg').classList.remove('hidden');
                document.getElementById('wait-others-msg').innerHTML = "<p>ä½ æ˜¯é ˜è¢–ï¼Œåç­‰å¤§å®¶æŒ‘é¸å¥½åœ–...</p>";
            } else {
                document.getElementById('player-upload-area').classList.remove('hidden');
                document.getElementById('wait-others-msg').classList.add('hidden');
                document.getElementById('p-area').style.display = 'none';
                document.getElementById('btn-upload').disabled = false;
            }
        }
        else if(data.phase === 'VOTING') {
            showPhase('phase-voting');
            startTimer(20, 'vote-timer');
            document.getElementById('vote-prompt').innerText = (peer.id === data.leaderId) ? "æŒ‘é¸ä¸€å¼µä½ æœ€å–œæ­¡çš„ (+2åˆ†)" : "æŒ‘é¸ä¸€å¼µä½ æœ€è¨å­çš„ (-1åˆ†)";
            renderGrid(data.photos);
            document.getElementById('btn-submit-vote').disabled = true;
            document.getElementById('btn-submit-vote').classList.remove('hidden');
        }
        else if(data.phase === 'RESULTS') {
            showPhase('phase-results');
            const html = data.players.sort((a,b)=>b.score-a.score).map(p => `<div>${p.name}: <b style="color:var(--primary-color)">${p.score}</b></div>`).join('');
            document.getElementById('round-scores').innerHTML = html;
        }
        else if(data.phase === 'FINAL') {
            switchView('view-final');
            const html = data.players.sort((a,b)=>b.score-a.score).map((p,i) => `<h3>#${i+1} ${p.name} - ${p.score}åˆ†</h3>`).join('');
            document.getElementById('final-list').innerHTML = html;
        }
    }

    function submitTopic() {
        const topic = document.getElementById('topic-input').value.trim();
        if(!topic) return;
        if(isHost) startUpload(topic);
        else conn.send({ type: 'SEND_TOPIC', topic: topic });
    }

    function uploadImg() {
        const file = document.getElementById('photo-input').files[0];
        if(!file) return alert("è¦é¸ç…§ç‰‡å–”");
        const reader = new FileReader();
        reader.onload = e => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const scale = Math.min(500/img.width, 500/img.height);
                canvas.width = img.width * scale; canvas.height = img.height * scale;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                
                if(isHost) { players.find(p=>p.id===peer.id).photo = dataUrl; checkAllUploads(); }
                else conn.send({ type: 'SEND_PHOTO', photo: dataUrl });

                document.getElementById('player-upload-area').classList.add('hidden');
                document.getElementById('wait-others-msg').classList.remove('hidden');
                document.getElementById('wait-others-msg').innerHTML = "<p>ä¸Šå‚³æˆåŠŸï¼Œç­‰å¾…å…¬å¸ƒ...</p>";
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function renderGrid(photos) {
        const grid = document.getElementById('voting-grid');
        grid.innerHTML = "";
        photos.forEach(p => {
            const div = document.createElement('div');
            div.className = "photo-card";
            div.innerHTML = `<img src="${p.img}">`;
            div.onclick = () => {
                document.querySelectorAll('.photo-card').forEach(c => c.classList.remove('selected'));
                div.classList.add('selected');
                selectedTargetId = p.id;
                document.getElementById('btn-submit-vote').disabled = false;
            };
            grid.appendChild(div);
        });
    }

    function confirmVote() {
        if(!selectedTargetId) return;
        if(isHost) recordVote(peer.id, selectedTargetId);
        else conn.send({ type: 'SEND_VOTE', targetId: selectedTargetId });
        document.getElementById('btn-submit-vote').classList.add('hidden');
    }

    // --- å°å·¥å…· ---
    function setupLobby() {
        showView('view-waiting');
        document.getElementById('display-room-id').innerText = roomId;
        document.getElementById('player-count').innerText = players.length;
        document.getElementById('player-list').innerHTML = players.map(p => `<span class="status-pill">${p.name}</span>`).join('');
        if(isHost) document.getElementById('start-game-btn').classList.remove('hidden');
        else document.getElementById('waiting-msg').classList.remove('hidden');
    }

    function startTimer(sec, elId) {
        let t = sec;
        const el = document.getElementById(elId);
        clearInterval(timerInt);
        el.innerText = t;
        timerInt = setInterval(() => {
            t--; el.innerText = t;
            if(t <= 0) clearInterval(timerInt);
        }, 1000);
    }

    function previewImg(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById('p-img').src = e.target.result;
                document.getElementById('p-area').style.display = 'block';
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function switchView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }
    function showPhase(id) { document.getElementById(id).classList.remove('hidden'); }
    function copyId() { navigator.clipboard.writeText(roomId); alert("æˆ¿è™Ÿå·²è¤‡è£½ï¼"); }

</script>
</body>
</html>
