<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èª°çš„ç›¸ç°¿? v0.61</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #00b894;
            --secondary-color: #00cec9;
            --bg-grad: linear-gradient(135deg, #2d3436 0%, #000000 100%);
            --card-bg: rgba(255, 255, 255, 0.1);
            --text-color: #dfe6e9;
            --accent-yellow: #fdcb6e;
            --danger-red: #ff7675;
            --success-green: #55efc4;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Segoe UI', "Microsoft JhengHei", sans-serif;
            background: var(--bg-grad); color: var(--text-color);
            margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden;
        }

        .container { width: 100%; max-width: 480px; padding: 15px; text-align: center; }
        .card {
            background: var(--card-bg); backdrop-filter: blur(12px); border-radius: 24px;
            padding: 20px; border: 1px solid rgba(255,255,255,0.15); margin-top: 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative;
        }

        h1 { background: linear-gradient(to right, var(--primary-color), var(--secondary-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 2.2rem; font-weight: 800; margin: 10px 0; }
        .hidden { display: none !important; }

        /* é€²åº¦æ¢ */
        .progress-container { width: 100%; background: rgba(255,255,255,0.1); height: 6px; border-radius: 4px; margin: 15px 0 5px 0; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--primary-color); width: 100%; transition: width 1s linear; }

        /* (2) ç¾åŒ–å¾Œçš„è¨­å®šå½ˆçª— */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .modal-content { 
            background: #2d3436; padding: 30px 25px; border-radius: 20px; width: 90%; max-width: 380px; 
            border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 20px 50px rgba(0,0,0,0.8);
        }
        .modal-title { color: var(--secondary-color); margin-top: 0; text-align: center; font-size: 1.5rem; margin-bottom: 20px;}
        .setting-item { margin-bottom: 15px; text-align: left; }
        .setting-item label { display: block; font-size: 0.9rem; color: #aaa; margin-bottom: 5px; }
        .setting-item select { width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid #555; border-radius: 8px; color: white; font-size: 1rem; outline: none; transition: 0.3s; }
        .setting-item select:focus { border-color: var(--primary-color); background: rgba(0,0,0,0.5); }

        /* è¼¸å…¥èˆ‡æŒ‰éˆ• */
        .input-group { display: flex; gap: 8px; margin-bottom: 12px; }
        input[type="text"] { flex: 1; padding: 12px; background: rgba(0,0,0,0.3); border: 2px solid #555; border-radius: 12px; color: white; font-size: 1rem; text-align: center; }
        .dice-btn { background: #555; border: none; border-radius: 12px; color: white; padding: 0 15px; cursor: pointer; }
        button.main-btn { width: 100%; background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); color: #fff; border: none; padding: 15px; font-size: 1.1rem; border-radius: 12px; cursor: pointer; font-weight: bold; margin-top: 10px; transition: transform 0.1s; }
        button.main-btn:active { transform: scale(0.98); }
        button.secondary-btn { width: 100%; background: transparent; border: 1px solid #666; color: #aaa; padding: 10px; margin-top: 10px; border-radius: 12px; cursor: pointer; }

        /* åå–® */
        .player-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 10px; margin-bottom: 8px; }
        .kick-btn { background: var(--danger-red); border: none; color: white; padding: 5px 10px; border-radius: 6px; font-size: 0.8rem; cursor: pointer; }

        /* (4) äº’å‹•ç‰† */
        .emoji-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; }
        .emoji-item { background: rgba(255,255,255,0.08); padding: 15px; border-radius: 15px; font-size: 2rem; cursor: pointer; transition: 0.2s; border: 1px solid rgba(255,255,255,0.05); }
        .emoji-item:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }

        /* é–‹çèˆ‡çµæœ */
        .reveal-card { position: relative; border-radius: 15px; overflow: hidden; border: 3px solid transparent; transition: 0.5s; background: #000; margin-bottom: 10px; }
        .reveal-card.is-leader { border-color: var(--success-green); box-shadow: 0 0 20px rgba(85, 239, 196, 0.4); }
        .reveal-card.is-most-voted { border-color: var(--danger-red); }
        
        .badge { position: absolute; top: 8px; right: 8px; padding: 5px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; z-index: 2; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .badge-leader { background: var(--success-green); color: #000; }
        .badge-most { background: var(--danger-red); color: #fff; }
        
        .owner-tag { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.8); color: white; font-size: 0.9rem; padding: 8px 0; font-weight: bold; }
        
        .score-delta { font-size: 0.8rem; margin-left: 8px; opacity: 0.8; }
        .delta-plus { color: var(--success-green); }
        .delta-minus { color: var(--danger-red); }

        .timer-text { font-size: 2.5rem; font-weight: 800; color: var(--danger-red); margin: 0; line-height: 1; }
        .version-tag { position: fixed; bottom: 8px; right: 12px; color: #555; font-size: 0.7rem; }
    </style>
</head>
<body>

<div class="container">
    <h1>èª°çš„ç›¸ç°¿?</h1>

    <div id="view-lobby" class="view">
        <div class="card">
            <h3>æº–å‚™é–‹å§‹</h3>
            <div class="input-group">
                <input type="text" id="player-name" placeholder="è¼¸å…¥æš±ç¨±" maxlength="10">
                <button class="dice-btn" onclick="applyRandomName()"><i class="fas fa-dice"></i></button>
            </div>
            <button class="main-btn" onclick="showSettings()">å»ºç«‹æˆ¿é–“ (Host)</button>
            <div style="margin: 15px 0; opacity: 0.5; font-size:0.9rem;">- æˆ– -</div>
            <input type="text" id="room-id-input" placeholder="è²¼ä¸Šæˆ¿è™Ÿ ID" style="margin-bottom: 10px;">
            <button class="main-btn" style="background: #444;" onclick="joinRoom()">åŠ å…¥æˆ¿é–“</button>
        </div>
    </div>

    <div id="modal-settings" class="modal hidden">
        <div class="modal-content">
            <h3 class="modal-title"><i class="fas fa-cog"></i> éŠæˆ²è¦å‰‡è¨­å®š</h3>
            
            <div class="setting-item">
                <label>éŠæˆ²è¼ªæ•¸</label>
                <select id="set-rounds">
                    <option value="1">1 è¼ª (æ¯äººç•¶ä¸€æ¬¡é ˜è¢–)</option>
                    <option value="2" selected>2 è¼ª (æ¨™æº–)</option>
                    <option value="3">3 è¼ª (è¼ƒé•·)</option>
                </select>
            </div>

            <div class="setting-item">
                <label>é ˜è¢–æ€è€ƒæ™‚é–“</label>
                <select id="set-topic-time">
                    <option value="15">15 ç§’ (æ¥µé€Ÿ)</option>
                    <option value="20" selected>20 ç§’ (æ¨™æº–)</option>
                    <option value="40">40 ç§’ (æ‚ é–’)</option>
                </select>
            </div>

            <div class="setting-item">
                <label>åœ–ç‰‡ä¸Šå‚³/é¸æ“‡æ™‚é–“</label>
                <select id="set-upload-time">
                    <option value="30">30 ç§’ (å¿«)</option>
                    <option value="50" selected>50 ç§’ (æ¨™æº–)</option>
                    <option value="90">90 ç§’ (æ…¢)</option>
                </select>
            </div>

            <button class="main-btn" onclick="createRoom()">ç¢ºèªä¸¦é–‹æˆ¿</button>
            <button class="secondary-btn" onclick="hideSettings()">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="view-waiting" class="view hidden">
        <div class="card">
            <div style="font-size:0.8rem; color:#888; margin-bottom:5px;">æˆ¿è™Ÿ (é»æ“Šè¤‡è£½)</div>
            <div style="font-size: 1.8rem; color: var(--accent-yellow); cursor: pointer; font-family: monospace; letter-spacing: 2px;" onclick="copyId()" id="display-room-id">...</div>
            
            <div id="player-list" style="margin: 20px 0; min-height: 100px;"></div>
            
            <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                <div style="font-size:0.8rem; color:#888">äº’å‹•ç‰†</div>
                <div class="emoji-grid">
                    <div id="e1" class="emoji-item" onclick="hitEmoji(1)">ğŸ”¥</div>
                    <div id="e2" class="emoji-item" onclick="hitEmoji(2)">ğŸ“·</div>
                    <div id="e3" class="emoji-item" onclick="hitEmoji(3)">ğŸº</div>
                </div>
            </div>

            <button id="start-game-btn" class="main-btn hidden" onclick="hostStartGame()">å…¨å“¡å‡ºç™¼</button>
            <p id="waiting-msg" class="hidden" style="color:#aaa; margin-top:15px;"><i class="fas fa-spinner fa-spin"></i> ç­‰å¾…æˆ¿ä¸»é–‹å§‹...</p>
        </div>
    </div>

    <div id="view-game" class="view hidden">
        <div class="card">
            <div id="phase-action" class="phase">
                <p id="leader-msg" style="color:var(--accent-yellow); margin-bottom:5px; font-weight:bold;"></p>
                <h2 id="topic-display" style="color:var(--secondary-color); min-height: 1.2em;">ç­‰å¾…...</h2>
                
                <div class="progress-container"><div id="action-bar" class="progress-bar"></div></div>
                <p class="timer-text" id="action-timer">--</p>
                
                <div id="leader-input-area" class="hidden" style="margin-top:15px;">
                    <input type="text" id="topic-input" placeholder="è«‹å‡ºé¡Œ (ä¾‹: æœ€åƒ8+9çš„å‹•ç‰©)">
                    <button class="main-btn" onclick="submitTopic()">ç™¼å¸ƒé¡Œç›®</button>
                </div>

                <div id="player-upload-area" class="hidden" style="margin-top:10px;">
                    <label for="photo-input" style="display:block; padding:30px; border:2px dashed #666; border-radius:15px; cursor:pointer; background:rgba(0,0,0,0.2);">
                        <i class="fas fa-camera" style="font-size:2rem; margin-bottom:10px; color:#aaa;"></i>
                        <p style="margin:0; color:#ccc;">é»æ“Šé¸æ“‡ç…§ç‰‡</p>
                    </label>
                    <input type="file" id="photo-input" accept="image/*" style="display:none" onchange="previewImg(this)">
                    
                    <div id="p-area" style="display:none; margin:15px 0;">
                        <img id="p-img" style="width:120px; height:120px; border-radius:12px; object-fit:cover; border: 2px solid #fff;">
                    </div>
                    <button class="main-btn" id="btn-upload" onclick="uploadImg()">ç¢ºèªä¸Šå‚³</button>
                </div>
                
                <div id="wait-others-msg" class="hidden" style="margin-top:20px; color:#aaa;">
                    <p><i class="fas fa-check-circle" style="color:var(--success-green)"></i> ç‹€æ…‹ï¼šå·²å°±ç·’</p>
                    <p style="font-size:0.8rem">ç­‰å¾…å…¶ä»–äºº...</p>
                </div>
            </div>

            <div id="phase-voting" class="phase hidden">
                <h3 id="vote-prompt" style="color:var(--accent-yellow); margin-bottom:10px;"></h3>
                <div class="progress-container"><div id="vote-bar" class="progress-bar"></div></div>
                <p class="timer-text" id="vote-timer">--</p>
                
                <div style="max-height: 50vh; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 15px; padding: 10px; margin-top:10px;">
                    <div class="photo-grid" id="voting-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"></div>
                </div>
                <button class="main-btn" id="btn-submit-vote" onclick="confirmVote()" disabled style="margin-top:15px;">ç¢ºå®šæŠ•ç¥¨</button>
            </div>

            <div id="phase-reveal" class="phase hidden">
                <h3 style="color:var(--accent-yellow)">çµæœæ­æ›‰</h3>
                <div id="reveal-grid" style="padding-bottom: 20px;"></div>
                <p style="color:#888; font-size:0.8rem;"><i class="fas fa-calculator"></i> æ­£åœ¨è¨ˆç®—å¾—åˆ†...</p>
            </div>

            <div id="phase-results" class="phase hidden">
                <h3>æœ¬å›åˆç©åˆ†</h3>
                <div id="round-scores" style="text-align:left;"></div>
            </div>
        </div>
    </div>

    <div id="view-final" class="view hidden">
        <div class="card">
            <h2 style="color:var(--accent-yellow)">ğŸ† æœ€çµ‚æ¦®è€€ ğŸ†</h2>
            <div id="final-list" style="text-align:left; margin-bottom:20px;"></div>
            <button class="main-btn" onclick="location.reload()">å›åˆ°é¦–é </button>
        </div>
    </div>
</div>

<div class="version-tag">v0.61 | Logic Fixes & UI Polish</div>

<script>
    // --- åŸºç¤è®Šæ•¸ ---
    const funnyNames = ["æ·¡æ°´é‡‘åŸæ­¦", "ä¸‰é‡åŠ‰å¾·è¯", "ç›¸ç°¿ç ´å£è€…", "è‡ªæ‹ç³»æ•™æˆ", "è·¯é‚Šçš„é‡è²“", "æ·±æµ·å¤§é³³æ¢¨", "è¿·è·¯çš„é‡Œé•·", "æ—©é¤åº—é˜¿å§¨"];
    
    let peer, conn, roomId;
    let myName = "";
    let isHost = false;
    let players = []; 
    let currentLeaderId = ""; 
    let selectedTargetId = null;
    let timerInt;
    let gameSettings = { rounds: 2, topicTime: 20, uploadTime: 50 };

    // åˆå§‹åŒ–
    window.onload = () => { applyRandomName(); };
    function applyRandomName() {
        document.getElementById('player-name').value = funnyNames[Math.floor(Math.random() * funnyNames.length)];
    }

    // --- è¨­å®šèˆ‡å»ºç«‹ ---
    function showSettings() {
        myName = document.getElementById('player-name').value.trim();
        if(!myName) return alert("è«‹å…ˆè¼¸å…¥æ‚¨çš„æš±ç¨±");
        document.getElementById('modal-settings').classList.remove('hidden');
    }
    function hideSettings() { document.getElementById('modal-settings').classList.add('hidden'); }

    function createRoom() {
        gameSettings.rounds = parseInt(document.getElementById('set-rounds').value);
        gameSettings.topicTime = parseInt(document.getElementById('set-topic-time').value);
        gameSettings.uploadTime = parseInt(document.getElementById('set-upload-time').value);
        hideSettings();
        
        peer = new Peer();
        peer.on('open', id => {
            isHost = true; roomId = id;
            players = [{ id: id, name: myName, score: 0, photo: null, votes: 0, voted: false, conn: null }];
            setupLobby();
        });
        peer.on('connection', c => {
            c.on('open', () => {
                c.on('data', data => handleHostRecv(data, c));
                c.send({ type: 'SYNC_SETTINGS', settings: gameSettings });
            });
            // è™•ç†æ–·ç·š (ç°¡æ˜“ç‰ˆ)
            c.on('close', () => { players = players.filter(p => p.id !== c.peer); broadcastLobby(); });
        });
    }

    function joinRoom() {
        myName = document.getElementById('player-name').value.trim();
        let targetId = document.getElementById('room-id-input').value.trim();
        if(!myName || !targetId) return alert("è«‹å¡«å¯«åå­—èˆ‡æˆ¿è™Ÿ");

        peer = new Peer();
        peer.on('open', id => {
            conn = peer.connect(targetId);
            conn.on('open', () => {
                conn.send({ type: 'JOIN', name: myName });
                roomId = targetId;
            });
            conn.on('data', data => handleClientRecv(data));
        });
    }

    // --- äº’å‹•èˆ‡è¸¢äºº ---
    const emojiPool = ["ğŸ”¥", "ğŸ˜", "ğŸº", "ğŸ’©", "â¤ï¸", "ğŸ‘»", "ğŸ‘€", "ğŸ’", "ğŸ¸"];
    function hitEmoji(slot) {
        if(isHost) handleEmojiLogic(slot);
        else if(conn) conn.send({ type: 'EMOJI_HIT', slot: slot });
    }
    function handleEmojiLogic(slot) {
        let next = emojiPool[Math.floor(Math.random()*emojiPool.length)];
        broadcast({ type: 'EMOJI_SYNC', slot: slot, emoji: next });
        document.getElementById('e'+slot).innerText = next;
    }

    function kickPlayer(pid) {
        if(!isHost) return;
        const target = players.find(p => p.id === pid);
        if(target && target.conn) {
            target.conn.send({ type: 'KICKED' });
            setTimeout(() => target.conn.close(), 500);
        }
        players = players.filter(p => p.id !== pid);
        broadcastLobby(); setupLobby();
    }

    // --- æ•¸æ“šå‚³è¼¸æ ¸å¿ƒ ---
    function handleHostRecv(data, c) {
        switch(data.type) {
            case 'JOIN':
                if(players.some(p => p.id === c.peer)) return;
                players.push({ id: c.peer, name: data.name, score: 0, photo: null, votes: 0, voted: false, conn: c });
                broadcastLobby(); setupLobby();
                break;
            case 'EMOJI_HIT': handleEmojiLogic(data.slot); break;
            case 'SEND_TOPIC': startUpload(data.topic); break;
            case 'SEND_PHOTO':
                let p = players.find(x => x.id === c.peer);
                if(p) p.photo = data.photo;
                checkAllUploads();
                break;
            case 'SEND_VOTE': recordVote(c.peer, data.targetId); break;
        }
    }

    function handleClientRecv(data) {
        switch(data.type) {
            case 'KICKED': alert("æ‚¨å·²è¢«æˆ¿ä¸»ç§»é™¤"); location.reload(); break;
            case 'SYNC_SETTINGS': gameSettings = data.settings; break;
            case 'LOBBY_DATA': players = data.list; setupLobby(); break;
            case 'EMOJI_SYNC': document.getElementById('e'+data.slot).innerText = data.emoji; break;
            case 'STATE_SYNC': renderState(data); break;
        }
    }

    function broadcastLobby() { broadcast({ type: 'LOBBY_DATA', list: players.map(p => ({id: p.id, name: p.name})) }); }
    function broadcast(msg) { players.forEach(p => { if(p.conn && p.conn.open) p.conn.send(msg); }); }

    // --- éŠæˆ²é‚è¼¯æ ¸å¿ƒ (Host Only) ---
    function hostStartGame() {
        if(players.length < 3) return alert("æœ€å°‘éœ€è¦ 3 ä½ç©å®¶");
        nextRound(0);
    }

    // (1) ä¿®æ­£å›åˆé‚è¼¯ï¼šç¢ºä¿ currentLeaderId æ­£ç¢ºè¨­ç½®ä¸¦å»£æ’­
    function nextRound(roundIdx) {
        const maxR = players.length * gameSettings.rounds;
        if(roundIdx >= maxR) {
            broadcastState('FINAL', { players: players.map(p => ({name:p.name, score:p.score})) });
            return;
        }

        // é‡ç½®ç‹€æ…‹
        players.forEach(p => { 
            p.photo = null; 
            p.votes = 0; 
            p.voted = false; 
            p.roundScoreDelta = 0; // æ–°å¢ï¼šè¨˜éŒ„ç•¶å‰è®Šå‹•
            p.isLeaderPick = false; // æ–°å¢
            p.isMostVoted = false;  // æ–°å¢
        });

        const leader = players[roundIdx % players.length];
        currentLeaderId = leader.id;
        
        // å»£æ’­æ–°çš„é ˜è¢– IDï¼Œè®“æ‰€æœ‰å®¢æˆ¶ç«¯æ›´æ–°
        broadcastState('WAIT_TOPIC', { 
            leaderId: leader.id, 
            leaderName: leader.name, 
            round: roundIdx 
        });
    }

    function startUpload(topic) { 
        broadcastState('UPLOADING', { topic: topic, leaderId: currentLeaderId }); 
    }

    function checkAllUploads() {
        const uploaders = players.filter(p => p.id !== currentLeaderId);
        // å¦‚æœæ‰€æœ‰éé ˜è¢–éƒ½ä¸Šå‚³äº†
        if(uploaders.every(p => p.photo)) {
            // éš¨æ©Ÿæ‰“äº‚
            const pool = uploaders.map(p => ({id: p.id, img: p.photo})).sort(() => Math.random() - 0.5);
            broadcastState('VOTING', { photos: pool, leaderId: currentLeaderId });
        }
    }

    // (3) ä¿®æ­£æŠ•ç¥¨é‚è¼¯ï¼šåˆ†é›¢é ˜è¢–ç¥¨èˆ‡å¤§çœ¾ç¥¨
    function recordVote(voterId, targetId) {
        let voter = players.find(p => p.id === voterId);
        if(!voter || voter.voted) return;
        voter.voted = true;

        let target = players.find(p => p.id === targetId);
        
        if(voterId === currentLeaderId) {
            // é ˜è¢–ç¥¨ï¼šåŠ åˆ†ä¸¦æ¨™è¨˜
            if(target) {
                target.score += 2;
                target.roundScoreDelta += 2;
                target.isLeaderPick = true; 
            }
        } else {
            // å¤§çœ¾ç¥¨ï¼šåƒ…è¨ˆæ•¸
            if(target) target.votes += 1;
        }

        // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰äººéƒ½æŠ•å®Œ
        if(players.every(p => p.voted)) {
            finalizeRound();
        }
    }

    function finalizeRound() {
        // æ‰¾å‡ºéé ˜è¢–ç©å®¶
        const others = players.filter(p => p.id !== currentLeaderId);
        
        // è¨ˆç®—æœ€é«˜ç¥¨ (å¤§çœ¾ç¥¨)
        const maxVotes = Math.max(...others.map(o => o.votes));
        
        // å¦‚æœæœ‰äººå¾—ç¥¨ > 0ï¼Œä¸”æ˜¯æœ€é«˜ï¼Œæ‰£åˆ†
        if(maxVotes > 0) {
            others.forEach(o => {
                if(o.votes === maxVotes) {
                    o.score = Math.max(0, o.score - 1);
                    o.roundScoreDelta -= 1;
                    o.isMostVoted = true;
                }
            });
        }

        // æº–å‚™æ­æ›‰æ•¸æ“š
        // æ³¨æ„ï¼šé€™è£¡åªå›å‚³æœ‰ä¸Šå‚³åœ–ç‰‡çš„äººçš„çµæœ
        const revealData = others.map(p => ({
            name: p.name,
            photo: p.photo,
            isLeaderPick: p.isLeaderPick,
            isMostVoted: p.isMostVoted
        }));

        broadcastState('REVEAL', { list: revealData });

        // æµç¨‹æ¨é€²
        setTimeout(() => {
            // å‚³é€ç©åˆ†æ¦œï¼ŒåŒ…å« scoreDelta
            broadcastState('RESULTS', { 
                players: players.map(p => ({
                    name: p.name, 
                    score: p.score, 
                    delta: p.roundScoreDelta 
                })) 
            });
            
            setTimeout(() => {
                let curR = parseInt(document.body.dataset.round || 0);
                nextRound(curR + 1);
            }, 5000); // ç©åˆ†æ¦œçœ‹ 5 ç§’
        }, 6000); // æ­æ›‰å‹•ç•«çœ‹ 6 ç§’
    }

    function broadcastState(phase, payload) {
        document.body.dataset.round = payload.round !== undefined ? payload.round : (document.body.dataset.round || 0);
        const state = { type: 'STATE_SYNC', phase: phase, ...payload };
        // Host è‡ªå·±ä¹Ÿè¦æ¸²æŸ“
        renderState(state);
        // å»£æ’­
        broadcast(state);
    }

    // --- UI æ¸²æŸ“ (Client + Host) ---
    function renderState(data) {
        switchView('view-game');
        document.querySelectorAll('.phase').forEach(p => p.classList.add('hidden'));
        
        // æ›´æ–°æœ¬åœ° currentLeaderId è®Šæ•¸ (é‡è¦ï¼ç¢ºä¿å®¢æˆ¶ç«¯é‚è¼¯ä¸€è‡´)
        if(data.leaderId) {
            // é€™è£¡ä¸éœ€è¦å…¨åŸŸè®Šæ•¸åŒæ­¥ï¼Œç›´æ¥ç”¨ data.leaderId åˆ¤æ–·å³å¯
        }

        if(data.phase === 'WAIT_TOPIC') {
            showPhase('phase-action');
            document.getElementById('topic-display').innerText = "é ˜è¢–æ­£åœ¨æ€è€ƒé¡Œç›®...";
            document.getElementById('leader-msg').innerText = (peer.id === data.leaderId) ? "ä½ æ˜¯é ˜è¢–" : `é ˜è¢–ï¼š${data.leaderName}`;
            
            // (1) é—œéµä¿®å¾©ï¼šæ¯æ¬¡å¼·åˆ¶æª¢æŸ¥é¡¯ç¤ºé‚è¼¯
            if(peer.id === data.leaderId) {
                document.getElementById('leader-input-area').classList.remove('hidden');
                document.getElementById('wait-others-msg').classList.add('hidden');
            } else {
                document.getElementById('leader-input-area').classList.add('hidden');
            }
            // éš±è—ä¸Šä¸€è¼ªçš„ä¸Šå‚³å€
            document.getElementById('player-upload-area').classList.add('hidden');
            document.getElementById('p-area').style.display = 'none'; // é‡ç½®é è¦½
            document.getElementById('photo-input').value = ''; // é‡ç½® input

            resetTimer(gameSettings.topicTime, 'action-timer', 'action-bar');
        }
        else if(data.phase === 'UPLOADING') {
            showPhase('phase-action');
            document.getElementById('topic-display').innerText = data.topic;
            document.getElementById('leader-input-area').classList.add('hidden');
            
            resetTimer(gameSettings.uploadTime, 'action-timer', 'action-bar');

            if(peer.id === data.leaderId) {
                document.getElementById('player-upload-area').classList.add('hidden');
                document.getElementById('wait-others-msg').classList.remove('hidden');
                document.getElementById('wait-others-msg').innerHTML = `<p><i class="fas fa-coffee"></i> é ˜è¢–ä¼‘æ¯ä¸­ï¼Œç­‰å¾…å­æ°‘ä¸Šå‚³...</p>`;
            } else {
                document.getElementById('player-upload-area').classList.remove('hidden');
                document.getElementById('wait-others-msg').classList.add('hidden');
            }
        }
        else if(data.phase === 'VOTING') {
            showPhase('phase-voting');
            resetTimer(20, 'vote-timer', 'vote-bar');
            
            document.getElementById('vote-prompt').innerText = (peer.id === data.leaderId) 
                ? "è«‹é¸æ“‡æœ€ç¬¦åˆçš„åœ–ç‰‡ (+2åˆ†)" 
                : "è«‹é¸æ“‡æœ€ä¸ç¬¦åˆçš„åœ–ç‰‡ (-1åˆ†)";
            
            renderVotingGrid(data.photos);
            document.getElementById('btn-submit-vote').disabled = true;
            document.getElementById('btn-submit-vote').classList.remove('hidden');
        }
        else if(data.phase === 'REVEAL') {
            showPhase('phase-reveal');
            renderReveal(data.list);
        }
        else if(data.phase === 'RESULTS') {
            showPhase('phase-results');
            // (3) é¡¯ç¤ºåˆ†æ•¸è®ŠåŒ–
            const html = data.players.sort((a,b)=>b.score-a.score).map(p => {
                let deltaHtml = "";
                if(p.delta > 0) deltaHtml = `<span class="score-delta delta-plus">(+${p.delta})</span>`;
                else if(p.delta < 0) deltaHtml = `<span class="score-delta delta-minus">(${p.delta})</span>`;
                
                return `<div class="player-row">
                    <span>${p.name}</span>
                    <div><b>${p.score} åˆ†</b>${deltaHtml}</div>
                </div>`;
            }).join('');
            document.getElementById('round-scores').innerHTML = html;
        }
        else if(data.phase === 'FINAL') {
            switchView('view-final');
            const html = data.players.sort((a,b)=>b.score-a.score).map((p,i) => 
                `<div class="player-row">
                    <span><i class="fas fa-trophy" style="color:${i===0?'gold':'#ccc'}"></i> #${i+1} ${p.name}</span>
                    <b>${p.score}åˆ†</b>
                </div>`).join('');
            document.getElementById('final-list').innerHTML = html;
        }
    }

    // --- è¼”åŠ©åŠŸèƒ½ ---
    function resetTimer(sec, textId, barId) {
        clearInterval(timerInt);
        const textEl = document.getElementById(textId);
        const barEl = document.getElementById(barId);
        let t = sec;
        
        textEl.innerText = t;
        // é‡ç½®å‹•ç•«
        barEl.style.transition = 'none';
        barEl.style.width = '100%';
        
        // å¼·åˆ¶é‡ç¹ª
        barEl.offsetHeight; 
        
        barEl.style.transition = `width ${sec}s linear`;
        barEl.style.width = '0%';
        
        timerInt = setInterval(() => {
            t--;
            textEl.innerText = t;
            if(t <= 0) clearInterval(timerInt);
        }, 1000);
    }

    function renderVotingGrid(photos) {
        const grid = document.getElementById('voting-grid'); grid.innerHTML = "";
        photos.forEach(p => {
            const div = document.createElement('div');
            div.style = "aspect-ratio:1/1; overflow:hidden; border-radius:12px; border:4px solid transparent; position:relative;";
            div.innerHTML = `<img src="${p.img}" style="width:100%; height:100%; object-fit:cover; display:block;">`;
            div.onclick = () => {
                document.querySelectorAll('#voting-grid > div').forEach(c => c.style.borderColor = 'transparent');
                div.style.borderColor = 'var(--accent-yellow)';
                selectedTargetId = p.id;
                document.getElementById('btn-submit-vote').disabled = false;
            };
            grid.appendChild(div);
        });
    }

    function renderReveal(list) {
        const grid = document.getElementById('reveal-grid'); grid.innerHTML = "";
        list.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = `reveal-card ${item.isLeaderPick ? 'is-leader' : ''} ${item.isMostVoted ? 'is-most-voted' : ''}`;
            div.style.opacity = "0";
            div.style.transform = "translateY(20px)";
            
            let badges = "";
            if(item.isLeaderPick) badges += `<div class="badge badge-leader"><i class="fas fa-heart"></i> é ˜è¢–æœ€æ„›</div>`;
            if(item.isMostVoted) badges += `<div class="badge badge-most" style="${item.isLeaderPick?'top:35px':''}"><i class="fas fa-thumbs-down"></i> æœ€ä¸ç¬¦åˆ</div>`;

            div.innerHTML = `
                <img src="${item.photo}" style="width:100%; aspect-ratio:1/1; object-fit:cover; display:block;">
                <div class="owner-tag">${item.name}</div>
                ${badges}
            `;
            grid.appendChild(div);
            
            setTimeout(() => {
                div.style.opacity = "1";
                div.style.transform = "translateY(0)";
            }, idx * 600);
        });
    }

    // --- åŸºç¤æ“ä½œ ---
    function submitTopic() {
        const t = document.getElementById('topic-input').value.trim();
        if(!t) return;
        if(isHost) startUpload(t); else conn.send({ type: 'SEND_TOPIC', topic: t });
    }
    function uploadImg() {
        const file = document.getElementById('photo-input').files[0];
        if(!file) return alert("è«‹é¸æ“‡ç…§ç‰‡");
        const reader = new FileReader();
        reader.onload = e => {
            resizeAndSend(e.target.result);
        };
        reader.readAsDataURL(file);
    }
    function resizeAndSend(base64Str) {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const maxDim = 600; 
            let w = img.width, h = img.height;
            if(w > h && w > maxDim) { h *= maxDim/w; w = maxDim; }
            else if(h > maxDim) { w *= maxDim/h; h = maxDim; }
            
            canvas.width = w; canvas.height = h;
            ctx.drawImage(img, 0, 0, w, h);
            const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
            
            if(isHost) { players.find(p=>p.id===peer.id).photo = dataUrl; checkAllUploads(); }
            else conn.send({ type: 'SEND_PHOTO', photo: dataUrl });
            
            document.getElementById('player-upload-area').classList.add('hidden');
            document.getElementById('wait-others-msg').classList.remove('hidden');
        };
        img.src = base64Str;
    }
    function confirmVote() {
        if(!selectedTargetId) return;
        if(isHost) recordVote(peer.id, selectedTargetId); else conn.send({ type: 'SEND_VOTE', targetId: selectedTargetId });
        document.getElementById('btn-submit-vote').classList.add('hidden');
    }
    function previewImg(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => { document.getElementById('p-img').src = e.target.result; document.getElementById('p-area').style.display = 'block'; };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function setupLobby() {
        switchView('view-waiting');
        document.getElementById('display-room-id').innerText = roomId;
        const listEl = document.getElementById('player-list');
        listEl.innerHTML = players.map(p => `
            <div class="player-row">
                <span>${p.name} ${p.id === roomId ? '<i class="fas fa-crown" style="color:gold"></i>' : ''}</span>
                ${isHost && p.id !== peer.id ? `<button class="kick-btn" onclick="kickPlayer('${p.id}')"><i class="fas fa-times"></i></button>` : ''}
            </div>`).join('');
        if(isHost) document.getElementById('start-game-btn').classList.remove('hidden');
        else document.getElementById('waiting-msg').classList.remove('hidden');
    }

    function copyId() { navigator.clipboard.writeText(roomId); alert("æˆ¿è™Ÿå·²è¤‡è£½ï¼"); }
    function switchView(id) { document.querySelectorAll('.view').forEach(v => v.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
    function showPhase(id) { document.getElementById(id).classList.remove('hidden'); }
</script>
</body>
</html>
