<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èª°çš„ç›¸ç°¿? v0.41</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            /* é‚„åŸ v0.3 é…è‰² */
            --primary-color: #00b894;
            --secondary-color: #00cec9;
            --bg-grad: linear-gradient(135deg, #2d3436 0%, #000000 100%);
            --card-bg: rgba(255, 255, 255, 0.1);
            --text-color: #dfe6e9;
            --accent-yellow: #fdcb6e;
            --danger-red: #ff7675;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Segoe UI', "Microsoft JhengHei", sans-serif;
            background: var(--bg-grad);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container { width: 100%; max-width: 480px; padding: 15px; text-align: center; }

        .card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.15);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            margin-top: 15px;
            position: relative;
        }

        h1 { 
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2.2rem; margin: 10px 0; font-weight: 800;
        }

        .hidden { display: none !important; }

        /* è¼¸å…¥çµ„ä»¶ */
        .input-group { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
        input[type="text"] {
            flex: 1; padding: 15px; background: rgba(0,0,0,0.4);
            border: 2px solid #555; border-radius: 12px; color: white;
            font-size: 1rem; text-align: center; outline: none;
        }
        input[type="text"]:focus { border-color: var(--primary-color); }
        
        .random-btn { 
            background: #444; color: white; border: none; padding: 15px; 
            border-radius: 12px; cursor: pointer; font-size: 1.1rem;
        }

        button.main-btn {
            width: 100%; background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: #fff; border: none; padding: 15px; font-size: 1.1rem;
            border-radius: 12px; cursor: pointer; font-weight: bold; margin-top: 10px;
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.98); }
        button:disabled { opacity: 0.6; cursor: not-allowed; }

        /* æˆ¿è™Ÿ */
        .room-display { font-size: 1.8rem; color: var(--accent-yellow); font-family: monospace; display: flex; align-items: center; justify-content: center; gap: 10px; margin: 10px 0; }
        
        /* äº’å‹• Emoji */
        .emoji-wall { display: flex; justify-content: center; gap: 12px; margin: 20px 0; }
        .emoji-btn { 
            font-size: 2rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            padding: 8px; border-radius: 12px; cursor: pointer;
        }

        /* ç…§ç‰‡ç‰† */
        .scroll-box { max-height: 50vh; overflow-y: auto; border-radius: 15px; background: rgba(0,0,0,0.2); padding: 10px; margin-bottom: 15px; }
        .photo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .photo-card { aspect-ratio: 1/1; border-radius: 12px; overflow: hidden; border: 4px solid transparent; cursor: pointer; }
        .photo-card img { width: 100%; height: 100%; object-fit: cover; }
        .photo-card.selected { border-color: var(--accent-yellow); }

        .timer { font-size: 3rem; font-weight: 800; color: var(--danger-red); margin: 5px 0; }
        .status-pill { background: rgba(255,255,255,0.1); padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; border: 1px solid rgba(255,255,255,0.2); margin: 3px; display: inline-block; }
        .version-tag { position: fixed; bottom: 8px; right: 12px; color: #555; font-size: 0.75rem; }
    </style>
</head>
<body>

<div class="container">
    <h1><i class="fas fa-camera-retro"></i> èª°çš„ç›¸ç°¿?</h1>

    <div id="view-lobby" class="view">
        <div class="card">
            <h3>æº–å‚™é–‹å§‹</h3>
            <div class="input-group">
                <input type="text" id="player-name" placeholder="è¼¸å…¥æš±ç¨±" maxlength="10">
                <button class="random-btn" onclick="randomName()"><i class="fas fa-dice"></i></button>
            </div>
            <button class="main-btn" id="btn-create" onclick="createRoom()">å»ºç«‹æˆ¿é–“ (Host)</button>
            <div style="margin: 15px 0; opacity: 0.5;">- æˆ– -</div>
            <input type="text" id="room-id-input" placeholder="è¼¸å…¥æˆ¿è™Ÿ ID">
            <button class="main-btn" id="btn-join" onclick="joinRoom()">åŠ å…¥æˆ¿é–“</button>
        </div>
    </div>

    <div id="view-waiting" class="view hidden">
        <div class="card">
            <p style="margin:0; color:#aaa;">æˆ¿é–“ä»£ç¢¼</p>
            <div class="room-display">
                <span id="display-room-id">...</span>
                <i class="fas fa-copy" style="font-size:1.1rem; cursor:pointer; color:#777" onclick="copyId()"></i>
            </div>
            <p>å·²åŠ å…¥ (<span id="player-count">0</span>/6)</p>
            <div id="player-list"></div>
            
            <div class="emoji-wall">
                <div id="e1" class="emoji-btn" onclick="hitEmoji(1)">ğŸŒ²</div>
                <div id="e2" class="emoji-btn" onclick="hitEmoji(2)">ğŸ“·</div>
                <div id="e3" class="emoji-btn" onclick="hitEmoji(3)">ğŸº</div>
            </div>

            <button id="start-game-btn" class="main-btn hidden" onclick="hostStartGame()">é–‹å§‹éŠæˆ²</button>
            <p id="waiting-msg" class="hidden" style="color:#aaa;">ç­‰å¾…æˆ¿ä¸»é–‹å§‹éŠæˆ²...</p>
        </div>
    </div>

    <div id="view-game" class="view hidden">
        <div class="card">
            <div id="phase-action" class="phase">
                <p id="leader-msg" style="color:var(--accent-yellow)"></p>
                <h2 id="topic-display" style="color:var(--secondary-color)">ç­‰å¾…å‡ºé¡Œ...</h2>
                <div class="timer" id="game-timer">--</div>
                
                <div id="leader-input-area" class="hidden">
                    <input type="text" id="topic-input" placeholder="å‡ºå€‹æœ‰è¶£çš„é¡Œç›®...">
                    <button class="main-btn" onclick="submitTopic()">ç™¼å¸ƒé¡Œç›®</button>
                </div>

                <div id="player-upload-area" class="hidden">
                    <label for="photo-input" style="display:block; padding:20px; border:2px dashed #666; border-radius:12px; cursor:pointer; margin-bottom:15px;">
                        <i class="fas fa-image" style="font-size:2rem; color:#aaa;"></i>
                        <p>é¸æ“‡ç…§ç‰‡</p>
                    </label>
                    <input type="file" id="photo-input" accept="image/*" style="display:none" onchange="previewImg(this)">
                    <div id="p-area" style="display:none; margin-bottom:15px;">
                        <img id="p-img" style="width:100px; height:100px; object-fit:cover; border-radius:10px;">
                    </div>
                    <button class="main-btn" id="btn-upload" onclick="uploadImg()">ç¢ºèªä¸Šå‚³</button>
                </div>

                <div id="wait-others-msg" class="hidden">
                    <p><i class="fas fa-check-circle" style="color:var(--primary-color)"></i> å·²å®Œæˆï¼Œç­‰å…¶ä»–äºº...</p>
                </div>
            </div>

            <div id="phase-voting" class="phase hidden">
                <h3 id="vote-prompt" style="color:var(--accent-yellow)"></h3>
                <div class="timer" id="vote-timer">--</div>
                <div class="scroll-box">
                    <div class="photo-grid" id="voting-grid"></div>
                </div>
                <button class="main-btn" id="btn-submit-vote" onclick="confirmVote()" disabled>ç¢ºèªæŠ•ç¥¨</button>
            </div>

            <div id="phase-results" class="phase hidden">
                <h3>å›åˆçµæœ</h3>
                <div id="round-scores" style="text-align:left; padding:10px;"></div>
                <p style="color:#aaa; font-size:0.8rem; margin-top:15px;">å€’æ•¸ 5 ç§’ä¸‹ä¸€å±€...</p>
            </div>
        </div>
    </div>

    <div id="view-final" class="view hidden">
        <div class="card">
            <h2 style="color:var(--accent-yellow)">ğŸ† éŠæˆ²çµæŸ ğŸ†</h2>
            <div id="final-list" style="text-align:left; margin-bottom:20px;"></div>
            <button class="main-btn" onclick="location.reload()">å›é¦–é </button>
        </div>
    </div>
</div>

<div class="version-tag">v0.41 | é‚„åŸé…è‰²èˆ‡ä¿®å¾©</div>

<script>
    // --- (4) åç¨±æ¸…å–® ---
    const funnyNames = ["æ·¡æ°´é‡‘åŸæ­¦", "å¤§å®‰å‘¨æ°å€«", "è¥¿é–€ç”ºæœ€å¸¥", "éš”å£è€ç‹", "ç›¸ç°¿æ”¶è—å®¶", "ç…§ç‰‡æˆ°å£«", "ç¶ è‰²å°ç²¾éˆ", "æ´¾å°ä¹‹ç‹", "è·¯éçš„å°æ˜"];
    
    let peer, conn, roomId;
    let myName = "";
    let isHost = false;
    let players = [];
    let currentLeaderId = "";
    let selectedTargetId = null;
    let timerInt;

    function randomName() {
        document.getElementById('player-name').value = funnyNames[Math.floor(Math.random()*funnyNames.length)];
    }

    // --- (1) ä¿®æ­£å»ºç«‹æˆ¿é–“é‚è¼¯ ---
    function createRoom() {
        myName = document.getElementById('player-name').value.trim();
        if(!myName) return alert("è«‹è¼¸å…¥æš±ç¨±");
        
        // ç«‹å³é¡¯ç¤ºè¼‰å…¥æ„Ÿ
        document.getElementById('btn-create').innerText = "é€£ç·šä¸­...";
        document.getElementById('btn-create').disabled = true;
        
        peer = new Peer();
        
        peer.on('open', id => {
            isHost = true;
            roomId = id;
            players = [{ id: id, name: myName, score: 0, photo: null, votes: 0, voted: false }];
            setupLobby();
        });

        peer.on('error', err => {
            alert("é€£ç·šå¤±æ•—: " + err.type);
            document.getElementById('btn-create').innerText = "å»ºç«‹æˆ¿é–“ (Host)";
            document.getElementById('btn-create').disabled = false;
        });

        peer.on('connection', c => {
            c.on('open', () => {
                c.on('data', data => handleHostRecv(data, c));
            });
        });
    }

    function joinRoom() {
        myName = document.getElementById('player-name').value.trim();
        let targetId = document.getElementById('room-id-input').value.trim();
        if(!myName || !targetId) return alert("è«‹å¡«å¯«åå­—èˆ‡æˆ¿è™Ÿ");

        document.getElementById('btn-join').innerText = "é€£ç·šä¸­...";
        peer = new Peer();
        peer.on('open', id => {
            conn = peer.connect(targetId);
            conn.on('open', () => {
                conn.send({ type: 'JOIN', name: myName });
                roomId = targetId;
            });
            conn.on('data', data => handleClientRecv(data));
        });
    }

    // --- Emoji äº’å‹• ---
    const emojiMap = ["ğŸŒ²", "ğŸ“·", "ğŸº", "ğŸ€", "ğŸ”¥", "ğŸ’", "ğŸ‘»", "ğŸ¦„", "ğŸŒˆ", "ğŸ•", "ğŸ¸"];
    function hitEmoji(slot) {
        if(isHost) handleEmojiLogic(slot);
        else if(conn) conn.send({ type: 'EMOJI_HIT', slot: slot });
    }
    function handleEmojiLogic(slot) {
        let nextEmoji = emojiMap[Math.floor(Math.random()*emojiMap.length)];
        broadcast({ type: 'EMOJI_SYNC', slot: slot, emoji: nextEmoji });
        document.getElementById('e'+slot).innerText = nextEmoji;
    }

    // --- è¨Šæ¯æ ¸å¿ƒ ---
    function handleHostRecv(data, c) {
        switch(data.type) {
            case 'JOIN':
                if(players.some(p => p.id === c.peer)) return;
                players.push({ id: c.peer, name: data.name, score: 0, photo: null, votes: 0, voted: false, conn: c });
                broadcast({ type: 'LOBBY_DATA', list: players.map(p => ({name:p.name})) });
                setupLobby();
                break;
            case 'EMOJI_HIT': handleEmojiLogic(data.slot); break;
            case 'SEND_TOPIC': startUpload(data.topic); break;
            case 'SEND_PHOTO':
                let p = players.find(x => x.id === c.peer);
                if(p) p.photo = data.photo;
                checkAllUploads();
                break;
            case 'SEND_VOTE': recordVote(c.peer, data.targetId); break;
        }
    }

    function handleClientRecv(data) {
        switch(data.type) {
            case 'LOBBY_DATA': players = data.list; setupLobby(); break;
            case 'EMOJI_SYNC': document.getElementById('e'+data.slot).innerText = data.emoji; break;
            case 'STATE_SYNC': renderState(data); break;
        }
    }

    function broadcast(msg) {
        players.forEach(p => { if(p.conn && p.conn.open) p.conn.send(msg); });
    }

    // --- éŠæˆ²é‚è¼¯ ---
    function hostStartGame() {
        if(players.length < 3) return alert("è‡³å°‘éœ€è¦ 3 ä½ç©å®¶");
        nextRound(0);
    }

    function nextRound(roundIdx) {
        const maxRounds = players.length * 2;
        if(roundIdx >= maxRounds) {
            broadcastState('FINAL', { players: players.map(p => ({name:p.name, score:p.score})) });
            return;
        }
        players.forEach(p => { p.photo = null; p.votes = 0; p.voted = false; });
        const leader = players[roundIdx % players.length];
        currentLeaderId = leader.id;
        broadcastState('WAIT_TOPIC', { leaderId: leader.id, leaderName: leader.name, round: roundIdx });
    }

    function startUpload(topic) {
        broadcastState('UPLOADING', { topic: topic, leaderId: currentLeaderId });
    }

    function checkAllUploads() {
        const uploaders = players.filter(p => p.id !== currentLeaderId);
        if(uploaders.every(p => p.photo)) {
            const pool = uploaders.map(p => ({id: p.id, img: p.photo})).sort(() => Math.random() - 0.5);
            broadcastState('VOTING', { photos: pool, leaderId: currentLeaderId });
        }
    }

    function recordVote(vId, tId) {
        let voter = players.find(p => p.id === vId);
        if(!voter || voter.voted) return;
        voter.voted = true;

        if(vId === currentLeaderId) {
            let target = players.find(p => p.id === tId);
            if(target) target.score += 2;
        } else {
            let target = players.find(p => p.id === tId);
            if(target) target.votes += 1;
        }

        if(players.every(p => p.voted)) {
            const others = players.filter(p => p.id !== currentLeaderId);
            const maxV = Math.max(...others.map(o => o.votes));
            if(maxV > 0) {
                others.forEach(o => {
                    if(o.votes === maxV) o.score = Math.max(0, o.score - 1);
                });
            }
            broadcastState('RESULTS', { players: players.map(p => ({name:p.name, score:p.score})) });
            setTimeout(() => {
                let currentR = parseInt(document.body.dataset.round || 0);
                nextRound(currentR + 1);
            }, 5000);
        }
    }

    function broadcastState(phase, payload) {
        document.body.dataset.round = payload.round !== undefined ? payload.round : (document.body.dataset.round || 0);
        const state = { type: 'STATE_SYNC', phase: phase, ...payload };
        renderState(state);
        broadcast(state);
    }

    // --- UI æ§åˆ¶ ---
    function renderState(data) {
        switchView('view-game');
        document.querySelectorAll('.phase').forEach(p => p.classList.add('hidden'));
        
        if(data.phase === 'WAIT_TOPIC') {
            showPhase('phase-action');
            document.getElementById('topic-display').innerText = "é ˜è¢–æ­£åœ¨æ€è€ƒé¡Œç›®...";
            document.getElementById('leader-input-area').classList.toggle('hidden', peer.id !== data.leaderId);
            document.getElementById('player-upload-area').classList.add('hidden');
            document.getElementById('leader-msg').innerText = peer.id === data.leaderId ? "ä½ æ˜¯é ˜è¢–" : "é ˜è¢–æ˜¯ " + data.leaderName;
            document.getElementById('wait-others-msg').classList.add('hidden');
        }
        else if(data.phase === 'UPLOADING') {
            showPhase('phase-action');
            document.getElementById('topic-display').innerText = "é¡Œç›®ï¼š" + data.topic;
            document.getElementById('leader-input-area').classList.add('hidden');
            startTimer(50, 'game-timer');

            if(peer.id === data.leaderId) {
                document.getElementById('player-upload-area').classList.add('hidden');
                document.getElementById('wait-others-msg').classList.remove('hidden');
                document.getElementById('wait-others-msg').innerHTML = "<p>ä½ æ˜¯é ˜è¢–ï¼Œåç­‰ç…§ç‰‡...</p>";
            } else {
                document.getElementById('player-upload-area').classList.remove('hidden');
                document.getElementById('wait-others-msg').classList.add('hidden');
                document.getElementById('p-area').style.display = 'none';
            }
        }
        else if(data.phase === 'VOTING') {
            showPhase('phase-voting');
            startTimer(20, 'vote-timer');
            document.getElementById('vote-prompt').innerText = (peer.id === data.leaderId) ? "æŠ•æœ€å–œæ­¡çš„ (+2åˆ†)" : "æŠ•æœ€è¨å­çš„ (-1åˆ†)";
            renderGrid(data.photos);
            document.getElementById('btn-submit-vote').disabled = true;
            document.getElementById('btn-submit-vote').classList.remove('hidden');
        }
        else if(data.phase === 'RESULTS') {
            showPhase('phase-results');
            const html = data.players.sort((a,b)=>b.score-a.score).map(p => `
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span>${p.name}</span> <b style="color:var(--primary-color)">${p.score} åˆ†</b>
                </div>`).join('');
            document.getElementById('round-scores').innerHTML = html;
        }
        else if(data.phase === 'FINAL') {
            switchView('view-final');
            const html = data.players.sort((a,b)=>b.score-a.score).map((p,i) => `<h3>#${i+1} ${p.name} - ${p.score}åˆ†</h3>`).join('');
            document.getElementById('final-list').innerHTML = html;
        }
    }

    function submitTopic() {
        const topic = document.getElementById('topic-input').value.trim();
        if(!topic) return;
        if(isHost) startUpload(topic);
        else conn.send({ type: 'SEND_TOPIC', topic: topic });
    }

    function uploadImg() {
        const file = document.getElementById('photo-input').files[0];
        if(!file) return alert("é¸å¼µç…§ç‰‡å§");
        const reader = new FileReader();
        reader.onload = e => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const scale = Math.min(500/img.width, 500/img.height);
                canvas.width = img.width * scale; canvas.height = img.height * scale;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                
                if(isHost) { players.find(p=>p.id===peer.id).photo = dataUrl; checkAllUploads(); }
                else conn.send({ type: 'SEND_PHOTO', photo: dataUrl });

                document.getElementById('player-upload-area').classList.add('hidden');
                document.getElementById('wait-others-msg').classList.remove('hidden');
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function renderGrid(photos) {
        const grid = document.getElementById('voting-grid');
        grid.innerHTML = "";
        photos.forEach(p => {
            const div = document.createElement('div');
            div.className = "photo-card";
            div.innerHTML = `<img src="${p.img}">`;
            div.onclick = () => {
                document.querySelectorAll('.photo-card').forEach(c => c.classList.remove('selected'));
                div.classList.add('selected');
                selectedTargetId = p.id;
                document.getElementById('btn-submit-vote').disabled = false;
            };
            grid.appendChild(div);
        });
    }

    function confirmVote() {
        if(!selectedTargetId) return;
        if(isHost) recordVote(peer.id, selectedTargetId);
        else conn.send({ type: 'SEND_VOTE', targetId: selectedTargetId });
        document.getElementById('btn-submit-vote').classList.add('hidden');
    }

    // --- å·¥å…· ---
    function setupLobby() {
        switchView('view-waiting');
        document.getElementById('display-room-id').innerText = roomId;
        document.getElementById('player-count').innerText = players.length;
        document.getElementById('player-list').innerHTML = players.map(p => `<span class="status-pill">${p.name}</span>`).join('');
        if(isHost) document.getElementById('start-game-btn').classList.remove('hidden');
        else document.getElementById('waiting-msg').classList.remove('hidden');
    }

    function startTimer(sec, elId) {
        let t = sec;
        const el = document.getElementById(elId);
        clearInterval(timerInt);
        el.innerText = t;
        timerInt = setInterval(() => {
            t--; el.innerText = t;
            if(t <= 0) clearInterval(timerInt);
        }, 1000);
    }

    function previewImg(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById('p-img').src = e.target.result;
                document.getElementById('p-area').style.display = 'block';
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function switchView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }
    function showPhase(id) { document.getElementById(id).classList.remove('hidden'); }
    function copyId() { navigator.clipboard.writeText(roomId); alert("å·²è¤‡è£½æˆ¿è™Ÿï¼"); }

</script>
</body>
</html>
