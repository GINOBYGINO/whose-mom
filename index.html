<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èª°çš„ç›¸ç°¿? v0.3</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #00b894;
            --secondary-color: #00cec9;
            --bg-grad: linear-gradient(135deg, #2d3436 0%, #000000 100%);
            --card-bg: rgba(255, 255, 255, 0.1);
            --text-color: #dfe6e9;
            --accent-yellow: #fdcb6e;
            --danger-red: #ff7675;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Segoe UI', "Microsoft JhengHei", sans-serif;
            background: var(--bg-grad);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            max-width: 480px;
            padding: 15px;
            text-align: center;
            padding-bottom: 50px;
        }

        .card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.15);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            margin-top: 15px;
            position: relative;
            overflow: hidden;
        }

        h1 { 
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2.2rem;
            margin: 10px 0;
            font-weight: 800;
        }

        .hidden { display: none !important; }

        /* è¼¸å…¥æ¡†èˆ‡æŒ‰éˆ• */
        input[type="text"] {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: rgba(0,0,0,0.4);
            border: 2px solid #555;
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            text-align: center;
            outline: none;
            transition: 0.3s;
        }
        input[type="text"]:focus { border-color: var(--primary-color); }

        button {
            width: 100%;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: #fff;
            border: none;
            padding: 15px;
            font-size: 1.1rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            transition: transform 0.1s;
            box-shadow: 0 4px 15px rgba(0,184,148,0.4);
        }
        button:active { transform: scale(0.98); }
        button:disabled { background: #636e72; cursor: not-allowed; box-shadow: none; opacity: 0.7; }

        /* æˆ¿è™Ÿé¡¯ç¤ºå€ */
        .room-id-display {
            font-family: monospace;
            font-size: 2rem;
            color: var(--accent-yellow);
            letter-spacing: 2px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .copy-btn {
            background: none; border: none; padding: 5px; width: auto; 
            color: #aaa; font-size: 1.2rem; box-shadow: none; cursor: pointer;
        }
        .copy-btn:active { transform: scale(0.9); color: white; }

        /* ç…§ç‰‡èˆ‡æ»‘å‹•è¦–çª—å„ªåŒ– */
        .scrollable-area {
            max-height: 55vh;
            overflow-y: auto;
            border-radius: 12px;
            padding: 5px;
            background: rgba(0,0,0,0.2);
            margin-bottom: 15px;
        }

        .photo-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 12px; 
        }

        .photo-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 1 / 1; /* å¼·åˆ¶æ­£æ–¹å½¢ */
            cursor: pointer;
            transition: transform 0.2s;
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* è£åˆ‡å¡«æ»¿ï¼Œä¸è®Šå½¢ */
            display: block;
        }

        .photo-item.selected-wrap {
            border: 4px solid var(--accent-yellow);
            transform: scale(0.95);
        }
        
        .photo-item.selected-wrap::after {
            content: 'å·²é¸å–';
            position: absolute;
            bottom: 0; left: 0; right: 0;
            background: var(--accent-yellow);
            color: #000;
            font-size: 0.8rem;
            font-weight: bold;
            padding: 4px;
        }

        .timer { font-size: 3rem; font-weight: 800; color: var(--danger-red); margin: 5px 0; text-shadow: 0 0 20px rgba(255, 118, 117, 0.5); }
        
        .status-pill {
            display: inline-block;
            background: rgba(255,255,255,0.1);
            padding: 6px 12px;
            border-radius: 20px;
            margin: 3px;
            font-size: 0.85rem;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .version-tag { position: fixed; bottom: 5px; right: 10px; color: #555; font-size: 0.7rem; }
    </style>
</head>
<body>

<div class="container">
    <h1><i class="fas fa-camera-retro"></i> èª°çš„ç›¸ç°¿?</h1>

    <div id="view-lobby" class="view">
        <div class="card">
            <h3>è¼¸å…¥ä½ çš„æš±ç¨±</h3>
            <input type="text" id="player-name" placeholder="ä¾‹å¦‚ï¼šæ·¡æ°´é‡‘åŸæ­¦" maxlength="10">
            <div style="height: 20px;"></div>
            <button id="btn-create" onclick="createRoom()">å»ºç«‹æˆ¿é–“ (Host)</button>
            <div style="margin: 15px 0; font-size:0.9rem; color:#aaa;">- æˆ– -</div>
            <input type="text" id="room-id-input" placeholder="è¼¸å…¥æˆ¿è™Ÿ ID">
            <button id="btn-join" onclick="joinRoom()">åŠ å…¥æˆ¿é–“</button>
        </div>
    </div>

    <div id="view-waiting" class="view hidden">
        <div class="card">
            <p style="margin:0; color:#aaa;">æˆ¿é–“ä»£ç¢¼</p>
            <div class="room-id-display">
                <span id="display-room-id">...</span>
                <button class="copy-btn" onclick="copyRoomId()"><i class="fas fa-copy"></i></button>
            </div>
            <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin:15px 0;">
            <p>å·²åŠ å…¥ç©å®¶ (<span id="player-count">0</span>/6)</p>
            <div id="player-list"></div>
            <br>
            <button id="start-game-btn" class="hidden" onclick="hostStartGame()">é–‹å§‹éŠæˆ²</button>
            <p id="waiting-msg" class="hidden" style="color:#aaa; font-size:0.9rem;">ç­‰å¾…æˆ¿ä¸»é–‹å§‹...</p>
        </div>
    </div>

    <div id="view-game" class="view hidden">
        <div class="card">
            
            <div id="phase-wait-topic" class="phase hidden">
                <h3><i class="fas fa-crown" style="color:var(--accent-yellow)"></i> ç­‰å¾…å‡ºé¡Œ</h3>
                <p id="leader-name-display" style="font-size:1.2rem; color:var(--primary-color)"></p>
                <p style="color:#aaa;">æ­£åœ¨æ€è€ƒé¡Œç›®...</p>
            </div>

            <div id="phase-leader-input" class="phase hidden">
                <h3 style="color:var(--accent-yellow)">ä½ æ˜¯æœ¬å›åˆé ˜è¢–</h3>
                <p>è«‹å‡ºä¸€å€‹é¡Œç›®ï¼Œè®“å¤§å®¶å¾ç›¸ç°¿æ‰¾åœ–</p>
                <input type="text" id="topic-input" placeholder="ä¾‹å¦‚ï¼šé€™å¼µç…§ç‰‡æœ‰è²éŸ³">
                <button onclick="submitTopicAction()">ç™¼å¸ƒé¡Œç›®</button>
            </div>

            <div id="phase-upload" class="phase hidden">
                <p style="margin-bottom:5px; color:#aaa;">é¡Œç›®</p>
                <h2 id="topic-display" style="color:var(--secondary-color); margin-top:0;"></h2>
                <div class="timer" id="upload-timer">50</div>
                
                <div id="upload-ui">
                    <label for="photo-input" style="display:block; padding:20px; border:2px dashed #666; border-radius:12px; cursor:pointer; margin-bottom:15px;">
                        <i class="fas fa-image" style="font-size:2rem; color:#aaa;"></i>
                        <p style="margin:5px 0;">é»æ“Šé¸æ“‡ç…§ç‰‡</p>
                    </label>
                    <input type="file" id="photo-input" accept="image/*" style="display:none;" onchange="previewPhoto(this)">
                    <div id="preview-area" style="display:none; margin-bottom:15px;">
                        <img id="img-preview" style="width:100px; height:100px; object-fit:cover; border-radius:8px;">
                    </div>
                    <button id="btn-upload" onclick="uploadAction()">ç¢ºèªä¸Šå‚³</button>
                </div>
                <div id="upload-wait-msg" class="hidden">
                    <i class="fas fa-check-circle" style="color:var(--primary-color); font-size:2rem;"></i>
                    <p>å·²é€å‡ºï¼ç­‰å¾…å…¶ä»–æ…¢ååçš„äºº...</p>
                </div>
            </div>

            <div id="phase-voting" class="phase hidden">
                <h3 id="voting-title" style="color:var(--accent-yellow)"></h3>
                <div class="timer" id="vote-timer">20</div>
                
                <div class="scrollable-area">
                    <div class="photo-grid" id="voting-grid"></div>
                </div>
                
                <button id="btn-vote" onclick="voteAction()" disabled>ç¢ºèªæŠ•ç¥¨</button>
                <p id="vote-wait-msg" class="hidden" style="color:#aaa;">å·²æŠ•ç¥¨ï¼Œç­‰å¾…é–‹ç¥¨...</p>
            </div>

            <div id="phase-results" class="phase hidden">
                <h3>å›åˆçµç®—</h3>
                <div class="scrollable-area" style="max-height: 40vh;">
                    <div id="round-scores" style="text-align:left; padding:0 10px;"></div>
                </div>
                <p style="color:#aaa; font-size:0.9rem;">5ç§’å¾Œé€²å…¥ä¸‹ä¸€å›åˆ...</p>
            </div>

        </div>
    </div>

    <div id="view-final" class="view hidden">
        <div class="card">
            <h2 style="color:var(--accent-yellow)">ğŸ† éŠæˆ²çµæŸ ğŸ†</h2>
            <div id="final-scores" style="text-align:left; margin:20px 0;"></div>
            <button onclick="location.reload()">å›åˆ°é¦–é </button>
        </div>
    </div>

</div>
<div class="version-tag">v0.3</div>

<script>
    // --- å…¨åŸŸè®Šæ•¸ ---
    let peer, conn, roomId;
    let myName = "";
    let isHost = false;
    let players = []; 
    
    // éŠæˆ²ç‹€æ…‹è®Šæ•¸
    let currentRound = 0;
    let currentLeaderId = "";
    let mySelectedPhotoId = null;
    let timerInterval;

    // --- 1. é€£ç·šèˆ‡å¤§å»³é‚è¼¯ ---

    function createRoom() {
        const nameInput = document.getElementById('player-name');
        if(!nameInput.value.trim()) return alert("è«‹è¼¸å…¥æš±ç¨±");
        
        // Host é˜²å‘†ï¼šé–å®šæŒ‰éˆ•
        document.getElementById('btn-create').disabled = true;
        document.getElementById('btn-join').disabled = true;

        myName = nameInput.value.trim();
        peer = new Peer();
        
        peer.on('open', id => {
            isHost = true;
            roomId = id;
            players = [{ id: id, name: myName, score: 0, photo: null, votes: 0, voted: false }];
            
            setupLobbyUI();
        });

        peer.on('connection', c => {
            c.on('open', () => {
                c.on('data', data => handleHostData(data, c));
            });
            c.on('close', () => {
                // ç°¡å–®è™•ç†æ–·ç·šï¼šç§»é™¤ç©å®¶ (æ­¤ç‰ˆæœ¬ç°¡åŒ–è™•ç†)
                players = players.filter(p => p.id !== c.peer);
                broadcast({ type: 'UPDATE_LOBBY', players: getPublicPlayers() });
                setupLobbyUI();
            });
        });
    }

    function joinRoom() {
        const nameInput = document.getElementById('player-name');
        const roomInput = document.getElementById('room-id-input');
        if(!nameInput.value.trim() || !roomInput.value.trim()) return alert("è«‹è¼¸å…¥æš±ç¨±èˆ‡æˆ¿è™Ÿ");

        document.getElementById('btn-create').disabled = true;
        document.getElementById('btn-join').disabled = true;

        myName = nameInput.value.trim();
        roomId = roomInput.value.trim();

        peer = new Peer();
        peer.on('open', id => {
            conn = peer.connect(roomId);
            conn.on('open', () => {
                conn.send({ type: 'JOIN', name: myName });
            });
            conn.on('data', data => handleClientData(data));
            
            // è™•ç†é€£ç·šå¤±æ•—
            setTimeout(() => {
                if(!document.getElementById('view-lobby').classList.contains('hidden')) {
                    alert("é€£ç·šé€¾æ™‚ï¼Œè«‹æª¢æŸ¥æˆ¿è™Ÿ");
                    document.getElementById('btn-create').disabled = false;
                    document.getElementById('btn-join').disabled = false;
                }
            }, 5000);
        });
    }

    // --- 2. è¨Šæ¯è™•ç† (Host & Client åˆ†é›¢) ---

    // Host å°ˆç”¨è™•ç†å‡½æ•¸
    function handleHostData(data, conn) {
        switch(data.type) {
            case 'JOIN':
                if(players.some(p => p.id === conn.peer)) return; // é˜²æ­¢é‡è¤‡
                players.push({ id: conn.peer, name: data.name, score: 0, photo: null, votes: 0, voted: false, conn: conn });
                broadcast({ type: 'UPDATE_LOBBY', players: getPublicPlayers() });
                setupLobbyUI();
                break;

            case 'CLIENT_TOPIC':
                // æ”¶åˆ°é ˜è¢–å‡ºçš„é¡Œç›® -> å»£æ’­é€²å…¥ä¸Šå‚³éšæ®µ
                startUploadPhase(data.topic);
                break;

            case 'CLIENT_PHOTO':
                // æ”¶åˆ°ç©å®¶ç…§ç‰‡
                let p = players.find(x => x.id === conn.peer);
                if(p) p.photo = data.photo;
                checkUploadStatus();
                break;

            case 'CLIENT_VOTE':
                // æ”¶åˆ°æŠ•ç¥¨
                recordVote(conn.peer, data.targetId);
                break;
        }
    }

    // Client å°ˆç”¨è™•ç†å‡½æ•¸
    function handleClientData(data) {
        switch(data.type) {
            case 'UPDATE_LOBBY':
                players = data.players; // å®¢æˆ¶ç«¯åªå­˜ç°¡æ˜“åå–®
                setupLobbyUI();
                break;

            case 'STATE_SYNC':
                syncGameUI(data.state);
                break;
        }
    }

    function broadcast(msg) {
        players.forEach(p => {
            if(p.conn && p.conn.open) p.conn.send(msg);
        });
    }

    function getPublicPlayers() {
        return players.map(p => ({ id: p.id, name: p.name, score: p.score }));
    }

    // --- 3. éŠæˆ²æ ¸å¿ƒé‚è¼¯ (Host) ---

    function hostStartGame() {
        if(players.length < 3) return alert("è‡³å°‘éœ€è¦ 3 äººæ‰èƒ½é–‹å§‹");
        currentRound = 0;
        nextRound();
    }

    function nextRound() {
        const totalRounds = players.length * 2;
        if(currentRound >= totalRounds) {
            broadcastState('FINAL', { players: getPublicPlayers() });
            return;
        }

        // --- é—œéµä¿®æ­£ï¼šå¾¹åº•é‡ç½®å›åˆç‹€æ…‹ ---
        players.forEach(p => {
            p.photo = null;
            p.votes = 0;
            p.voted = false;
        });

        // æ±ºå®šé ˜è¢–
        const leader = players[currentRound % players.length];
        currentLeaderId = leader.id;
        currentRound++;

        broadcastState('WAIT_TOPIC', { 
            leaderId: leader.id, 
            leaderName: leader.name 
        });
    }

    function startUploadPhase(topic) {
        broadcastState('UPLOADING', { topic: topic, leaderId: currentLeaderId });
    }

    function checkUploadStatus() {
        // é ˜è¢–ä¸ç”¨ä¸Šå‚³ï¼Œæª¢æŸ¥å…¶ä»–äººæ˜¯å¦éƒ½å‚³äº†
        const others = players.filter(p => p.id !== currentLeaderId);
        if(others.every(p => p.photo)) {
            // æ´—ç‰Œç…§ç‰‡
            const photos = others.map(p => ({ id: p.id, img: p.photo })).sort(() => Math.random() - 0.5);
            broadcastState('VOTING', { photos: photos, leaderId: currentLeaderId });
        }
    }

    function recordVote(voterId, targetId) {
        let voter = players.find(p => p.id === voterId);
        if(!voter || voter.voted) return; // é˜²æ­¢é‡è¤‡æŠ•
        
        voter.voted = true;

        const isLeader = (voterId === currentLeaderId);
        
        if (isLeader) {
            // é ˜è¢–ç¥¨ï¼šå¾—ä¸»+2åˆ†
            let target = players.find(p => p.id === targetId);
            if(target) target.score += 2;
        } else {
            // é–’é›œäººç­‰ç¥¨ï¼šå¾—ä¸»ç¥¨æ•¸+1 (ç¨å¾Œç®—æ‰£åˆ†)
            let target = players.find(p => p.id === targetId);
            if(target) target.votes += 1;
        }

        // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰äººéƒ½æŠ•äº†
        if(players.every(p => p.voted)) {
            calculateScores();
        }
    }

    function calculateScores() {
        // æ‰£åˆ†é‚è¼¯
        const others = players.filter(p => p.id !== currentLeaderId);
        if(others.length > 0) {
            const maxVotes = Math.max(...others.map(o => o.votes));
            const losers = others.filter(o => o.votes === maxVotes);
            // åªæœ‰ä¸€äººæœ€é«˜ç¥¨æ‰æ‰£åˆ†
            if(maxVotes > 0 && losers.length === 1) {
                losers[0].score = Math.max(0, losers[0].score - 1);
            }
        }

        broadcastState('RESULTS', { players: getPublicPlayers() });
        
        // 5ç§’å¾Œä¸‹ä¸€å±€
        setTimeout(() => nextRound(), 5000);
    }

    function broadcastState(phase, payload) {
        const state = { phase: phase, ...payload };
        // Host è‡ªå·±ä¹Ÿè¦åŒæ­¥ UI
        syncGameUI(state); 
        // å»£æ’­çµ¦å…¶ä»–äºº
        players.forEach(p => {
            if(p.conn) p.conn.send({ type: 'STATE_SYNC', state: state });
        });
    }

    // --- 4. UI åŒæ­¥èˆ‡æ¸²æŸ“ (Client & Host å…±ç”¨) ---

    function syncGameUI(state) {
        showView('view-game');
        hideAllPhases();
        
        // æ¸…ç†ä¸Šä¸€å±€æ®˜ç•™çš„è¼¸å…¥
        document.getElementById('photo-input').value = "";
        document.getElementById('preview-area').style.display = "none";
        document.getElementById('btn-upload').classList.remove('hidden');
        document.getElementById('upload-ui').classList.remove('hidden');
        document.getElementById('btn-vote').disabled = true;
        document.getElementById('btn-vote').classList.remove('hidden');
        document.getElementById('vote-wait-msg').classList.add('hidden');
        mySelectedPhotoId = null;

        switch(state.phase) {
            case 'WAIT_TOPIC':
                if(peer.id === state.leaderId) {
                    document.getElementById('topic-input').value = "";
                    showPhase('phase-leader-input');
                } else {
                    document.getElementById('leader-name-display').innerText = state.leaderName;
                    showPhase('phase-wait-topic');
                }
                break;

            case 'UPLOADING':
                showPhase('phase-upload');
                document.getElementById('topic-display').innerText = state.topic;
                
                if(peer.id === state.leaderId) {
                    document.getElementById('upload-ui').classList.add('hidden');
                    document.getElementById('upload-wait-msg').classList.remove('hidden');
                    document.getElementById('upload-wait-msg').innerHTML = "<p>ä½ æ˜¯é ˜è¢–ï¼Œç­‰å¾…å­æ°‘ä¸Šå‚³...</p>";
                } else {
                    document.getElementById('upload-wait-msg').classList.add('hidden');
                    startCountdown(50, 'upload-timer');
                }
                break;

            case 'VOTING':
                showPhase('phase-voting');
                renderVotingGrid(state.photos);
                const amILeader = (peer.id === state.leaderId);
                document.getElementById('voting-title').innerText = amILeader ? "é¸ä¸€å¼µæœ€å–œæ­¡çš„ (+2åˆ†)" : "é¸ä¸€å¼µæœ€çˆ›çš„ (-1åˆ†)";
                startCountdown(20, 'vote-timer');
                break;

            case 'RESULTS':
                showPhase('phase-results');
                renderResults(state.players);
                break;

            case 'FINAL':
                showView('view-final');
                renderFinal(state.players);
                break;
        }
    }

    // --- 5. ç”¨æˆ¶äº¤äº’å‹•ä½œ ---

    function submitTopicAction() {
        const topic = document.getElementById('topic-input').value.trim();
        if(!topic) return alert("è«‹è¼¸å…¥é¡Œç›®");
        
        if(isHost) startUploadPhase(topic);
        else conn.send({ type: 'CLIENT_TOPIC', topic: topic });
    }

    function previewPhoto(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('img-preview').src = e.target.result;
                document.getElementById('preview-area').style.display = 'block';
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function uploadAction() {
        const fileInput = document.getElementById('photo-input');
        if(!fileInput.files[0]) return alert("é‚„æ²’é¸ç…§ç‰‡å–”");

        // å£“ç¸®åœ–ç‰‡
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                // å¼·åˆ¶å£“ç¸®è‡³ 500px å…§ï¼Œç•«è³ª 0.6
                const scale = Math.min(500/img.width, 500/img.height);
                canvas.width = img.width * scale;
                canvas.height = img.height * scale;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                const dataUrl = canvas.toDataURL('image/jpeg', 0.6);

                if(isHost) {
                    players.find(p => p.id === peer.id).photo = dataUrl;
                    checkUploadStatus();
                } else {
                    conn.send({ type: 'CLIENT_PHOTO', photo: dataUrl });
                }

                document.getElementById('upload-ui').classList.add('hidden');
                document.getElementById('upload-wait-msg').classList.remove('hidden');
                document.getElementById('upload-wait-msg').innerHTML = "<p>ä¸Šå‚³æˆåŠŸï¼ç­‰å¾…å…¶ä»–äºº...</p>";
            }
            img.src = e.target.result;
        }
        reader.readAsDataURL(fileInput.files[0]);
    }

    function renderVotingGrid(photos) {
        const grid = document.getElementById('voting-grid');
        grid.innerHTML = "";
        
        photos.forEach(p => {
            const div = document.createElement('div');
            div.className = "photo-item";
            div.innerHTML = `<img src="${p.img}">`;
            div.onclick = function() {
                // UI é¸å–æ•ˆæœ
                document.querySelectorAll('.photo-item').forEach(el => el.classList.remove('selected-wrap'));
                div.classList.add('selected-wrap');
                
                mySelectedPhotoId = p.id;
                document.getElementById('btn-vote').disabled = false;
            };
            grid.appendChild(div);
        });
    }

    function voteAction() {
        if(!mySelectedPhotoId) return;
        
        if(isHost) recordVote(peer.id, mySelectedPhotoId);
        else conn.send({ type: 'CLIENT_VOTE', targetId: mySelectedPhotoId });

        document.getElementById('btn-vote').classList.add('hidden');
        document.getElementById('vote-wait-msg').classList.remove('hidden');
    }

    // --- è¼”åŠ©å‡½å¼ ---

    function setupLobbyUI() {
        document.getElementById('display-room-id').innerText = roomId;
        document.getElementById('player-count').innerText = players.length;
        document.getElementById('player-list').innerHTML = players.map(p => 
            `<span class="status-pill">${p.name}</span>`
        ).join('');
        
        // åªæœ‰ Host çœ‹å¾—åˆ°é–‹å§‹æŒ‰éˆ•
        if(isHost) {
            document.getElementById('start-game-btn').classList.remove('hidden');
            document.getElementById('waiting-msg').classList.add('hidden');
        } else {
            document.getElementById('waiting-msg').classList.remove('hidden');
        }
        
        showView('view-waiting');
    }

    function showView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
        document.getElementById(viewId).classList.remove('hidden');
    }

    function hideAllPhases() {
        document.querySelectorAll('.phase').forEach(p => p.classList.add('hidden'));
    }

    function showPhase(phaseId) {
        document.getElementById(phaseId).classList.remove('hidden');
    }

    function startCountdown(seconds, elemId) {
        let t = seconds;
        const el = document.getElementById(elemId);
        clearInterval(timerInterval);
        el.innerText = t;
        timerInterval = setInterval(() => {
            t--;
            el.innerText = t;
            if(t <= 0) clearInterval(timerInterval);
        }, 1000);
    }

    function copyRoomId() {
        const text = document.getElementById('display-room-id').innerText;
        navigator.clipboard.writeText(text).then(() => {
            alert("å·²è¤‡è£½æˆ¿è™Ÿï¼");
        });
    }

    function renderResults(playerList) {
        const sorted = [...playerList].sort((a,b) => b.score - a.score);
        const html = sorted.map((p, idx) => `
            <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid rgba(255,255,255,0.1);">
                <span>#${idx+1} ${p.name}</span>
                <span style="color:var(--primary-color); font-weight:bold;">${p.score} åˆ†</span>
            </div>
        `).join('');
        document.getElementById('round-scores').innerHTML = html;
    }

    function renderFinal(playerList) {
        const sorted = [...playerList].sort((a,b) => b.score - a.score);
        const html = sorted.map((p, idx) => `
            <div style="background:rgba(255,255,255,0.1); padding:15px; margin:10px 0; border-radius:10px;">
                <span style="font-size:1.5rem;">${idx === 0 ? 'ğŸ‘‘' : `#${idx+1}`}</span>
                <span style="font-size:1.2rem; margin-left:10px;">${p.name}</span>
                <div style="float:right; color:var(--accent-yellow); font-size:1.5rem;">${p.score}</div>
            </div>
        `).join('');
        document.getElementById('final-scores').innerHTML = html;
    }
</script>
</body>
</html>
